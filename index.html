<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StockPulse</title>
<style>
:root {
  --bg: #0a0a0f;
  --bg2: #111118;
  --bg3: #1a1a24;
  --border: #2a2a3a;
  --text: #e8e8f0;
  --mu: #666680;
  --acc: #f0a500;
  --green: #00d68f;
  --red: #ff4466;
  --blue: #4488ff;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--text); font-family: 'IBM Plex Mono', monospace; font-size: 13px; }

/* ── TOP BAR ── */
#topbar {
  display: flex; align-items: center; gap: 12px;
  padding: 10px 16px; background: var(--bg2);
  border-bottom: 1px solid var(--border);
}
#logo { font-size: 15px; font-weight: 700; letter-spacing: 1px; }
#logo span { color: var(--acc); }
#topbar-right { margin-left: auto; font-size: 11px; color: var(--mu); }

/* ── INPUT PANEL ── */
#inputPanel {
  display: flex; gap: 12px; align-items: flex-start;
  padding: 14px 16px; background: var(--bg2);
  border-bottom: 1px solid var(--border); flex-wrap: wrap;
}
textarea {
  background: var(--bg3); border: 1px solid var(--border);
  color: var(--text); font-family: inherit; font-size: 12px;
  padding: 8px 10px; border-radius: 4px; resize: vertical;
  width: 220px; height: 80px; outline: none;
}
textarea:focus { border-color: var(--acc); }
.exch-btns { display: flex; gap: 6px; flex-direction: column; }
.exch-btn {
  background: var(--bg3); border: 1px solid var(--border);
  color: var(--mu); font-family: inherit; font-size: 11px;
  padding: 5px 12px; border-radius: 4px; cursor: pointer;
}
.exch-btn.active { border-color: var(--acc); color: var(--acc); }
.btn {
  background: transparent; border: 1px solid var(--border);
  color: var(--text); font-family: inherit; font-size: 12px;
  padding: 7px 14px; border-radius: 4px; cursor: pointer;
  white-space: nowrap;
}
.btn:hover { border-color: var(--acc); color: var(--acc); }
.btn.primary { background: var(--acc); border-color: var(--acc); color: #000; font-weight: 700; }
.btn.primary:hover { background: #ffb800; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }

/* ── DB CHIPS ── */
#dbPanel {
  padding: 8px 16px; background: var(--bg2);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
  min-height: 36px;
}
#dbLabel { font-size: 11px; color: var(--mu); white-space: nowrap; }
#dbChips { display: flex; gap: 6px; flex-wrap: wrap; flex: 1; }
.chip {
  display: inline-flex; align-items: center; gap: 5px;
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 3px; padding: 2px 7px; font-size: 11px;
}
.chip-n { color: var(--mu); font-size: 10px; }
.chip-x {
  cursor: pointer; color: var(--mu); font-size: 12px; line-height: 1;
}
.chip-x:hover { color: var(--red); }

/* ── STATUS BAR ── */
#statusBar {
  display: none; padding: 5px 16px;
  background: var(--bg2); border-bottom: 1px solid var(--border);
  font-size: 11px; color: var(--mu);
}
#statusBar.on { display: flex; align-items: center; gap: 16px; }
.stat-item { display: flex; align-items: center; gap: 4px; }
.stat-val { color: var(--text); font-weight: 600; }
.stat-val.green { color: var(--green); }
.stat-val.red { color: var(--red); }
#progText { margin-left: auto; }

/* ── TABLE ── */
#tableWrap { overflow: auto; flex: 1; }
table { width: 100%; border-collapse: collapse; min-width: 700px; }
thead th {
  background: var(--bg2); position: sticky; top: 0; z-index: 10;
  padding: 8px 12px; text-align: left; font-size: 10px;
  color: var(--mu); font-weight: 600; letter-spacing: .5px;
  border-bottom: 1px solid var(--border); white-space: nowrap;
  cursor: pointer; user-select: none;
}
thead th:hover { color: var(--text); }
tbody tr { border-bottom: 1px solid #16161e; }
tbody tr:hover { background: #13131b; }
td { padding: 7px 12px; font-size: 12px; white-space: nowrap; }
.sym { font-weight: 700; font-size: 13px; }
.exch-tag { font-size: 9px; color: var(--mu); margin-left: 3px; }
.name-cell { color: var(--mu); font-size: 11px; max-width: 160px; overflow: hidden; text-overflow: ellipsis; }
.price { font-family: 'IBM Plex Mono', monospace; }
.up { color: var(--green); }
.dn { color: var(--red); }
.mu { color: var(--mu); }
.err-msg { color: var(--red); font-size: 11px; }
.loading { color: var(--mu); font-size: 11px; font-style: italic; }

#emptyMsg {
  text-align: center; padding: 60px 20px;
  color: var(--mu); font-size: 12px; display: none;
}

/* ── TOAST ── */
#toast {
  position: fixed; bottom: 20px; right: 20px;
  background: var(--bg3); border: 1px solid var(--border);
  padding: 10px 16px; border-radius: 4px; font-size: 12px;
  opacity: 0; transition: opacity .2s; pointer-events: none; z-index: 999;
}
#toast.show { opacity: 1; }
#toast.ok { border-color: var(--green); color: var(--green); }
#toast.err { border-color: var(--red); color: var(--red); }
</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

<!-- TOP BAR -->
<div id="topbar">
  <div id="logo">STOCK<span>PULSE</span>.IN</div>
  <div style="color:var(--mu);font-size:11px">// NSE BSE Momentum Terminal</div>
  <div id="topbar-right" id="lastUpd">awaiting data</div>
</div>

<!-- INPUT PANEL -->
<div id="inputPanel">
  <div>
    <div style="font-size:10px;color:var(--mu);margin-bottom:4px">ADD TICKERS &nbsp;<span id="dbCount" style="color:var(--acc)">DB: 0</span></div>
    <textarea id="tickerInput" placeholder="RELIANCE&#10;TCS&#10;INFY&#10;(bare symbols, auto-suffix)"></textarea>
  </div>
  <div class="exch-btns">
    <div style="font-size:10px;color:var(--mu);margin-bottom:4px">EXCHANGE</div>
    <button class="exch-btn active" id="btnNS" onclick="setExch('NS')">NSE (.NS)</button>
    <button class="exch-btn" id="btnBO" onclick="setExch('BO')">BSE (.BO)</button>
  </div>
  <div style="display:flex;flex-direction:column;gap:8px;padding-top:18px">
    <button class="btn primary" onclick="addAndFetch()">+ Add &amp; Fetch Prices</button>
    <button class="btn" id="refreshBtn" onclick="refreshAll()" disabled>⟳ Refresh All Prices</button>
    <button class="btn" onclick="clearAll()">✕ Clear Table</button>
  </div>
</div>

<!-- DB CHIPS -->
<div id="dbPanel">
  <span id="dbLabel">MY STOCKS (0)</span>
  <div id="dbChips"></div>
</div>

<!-- STATUS BAR -->
<div id="statusBar">
  <span class="stat-item">TOTAL <span class="stat-val" id="sTot">0</span></span>
  <span class="stat-item">OK <span class="stat-val green" id="sOk">0</span></span>
  <span class="stat-item">ERR <span class="stat-val red" id="sErr">0</span></span>
  <span id="progText"></span>
</div>

<!-- TABLE -->
<div id="tableWrap">
  <div id="emptyMsg">Add tickers above and click "Add &amp; Fetch Prices"</div>
  <table id="mainTable" style="display:none">
    <thead>
      <tr>
        <th>TICKER</th>
        <th>NAME</th>
        <th>PRICE ₹</th>
        <th>% DAY</th>
        <th>52W HIGH</th>
        <th>52W LOW</th>
        <th>MCAP CR</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div id="toast"></div>

<script>
// ─────────────────────────────────────────
// CONFIG
// ─────────────────────────────────────────
var DB_KEY = 'sp5_db';      // localStorage key for ticker DB
var exch = 'NS';             // default exchange suffix

// ─────────────────────────────────────────
// STATE
// ─────────────────────────────────────────
var tickerDb = [];   // [{n, sym, added}]
var tableData = {};  // {sym: rowData}
var fetchCount = 0;  // how many fetches in flight

// ─────────────────────────────────────────
// DB — persist tickers in localStorage
// ─────────────────────────────────────────
function dbLoad() {
  try { tickerDb = JSON.parse(localStorage.getItem(DB_KEY)) || []; } catch(e) { tickerDb = []; }
}
function dbSave() {
  localStorage.setItem(DB_KEY, JSON.stringify(tickerDb));
}
function dbHas(sym) {
  return tickerDb.some(function(t) { return t.sym === sym; });
}
function dbNextN() {
  return tickerDb.length ? Math.max.apply(null, tickerDb.map(function(t){ return t.n; })) + 1 : 1;
}

// ─────────────────────────────────────────
// EXCHANGE
// ─────────────────────────────────────────
function setExch(e) {
  exch = e;
  document.getElementById('btnNS').className = 'exch-btn' + (e==='NS' ? ' active' : '');
  document.getElementById('btnBO').className = 'exch-btn' + (e==='BO' ? ' active' : '');
}

// ─────────────────────────────────────────
// PARSE TICKERS from textarea
// ─────────────────────────────────────────
function parseTickers(raw) {
  return raw.split(/[\n,\s]+/)
    .map(function(s) { s = s.trim().toUpperCase(); if (!s) return null;
      // If already has suffix, keep it; else add exchange suffix
      if (s.indexOf('.') >= 0) return s;
      return s + '.' + exch;
    })
    .filter(Boolean);
}

// ─────────────────────────────────────────
// RENDER DB PANEL (chips)
// ─────────────────────────────────────────
function renderDb() {
  document.getElementById('dbCount').textContent = 'DB: ' + tickerDb.length;
  document.getElementById('dbLabel').textContent = 'MY STOCKS (' + tickerDb.length + ')';
  var h = '';
  for (var i = 0; i < tickerDb.length; i++) {
    var t = tickerDb[i];
    var disp = t.sym.replace('.NS','').replace('.BO','');
    h += '<span class="chip"><span class="chip-n">#' + t.n + '</span>' + disp +
         '<span class="chip-x" onclick="removeStock(\'' + t.sym + '\')">×</span></span>';
  }
  document.getElementById('dbChips').innerHTML = h;
  document.getElementById('refreshBtn').disabled = tickerDb.length === 0;
}

function removeStock(sym) {
  tickerDb = tickerDb.filter(function(t) { return t.sym !== sym; });
  dbSave();
  renderDb();
  delete tableData[sym];
  renderTable();
  showToast(sym + ' removed', '');
}

// ─────────────────────────────────────────
// FETCH PRICE — always via Netlify function
// Function handles Yahoo server-side (no CORS)
// ─────────────────────────────────────────
var FUNCTION_URL = '/.netlify/functions/quote';

function fetchPrice(sym) {
  var url = FUNCTION_URL + '?sym=' + encodeURIComponent(sym) + '&range=5d';
  return fetch(url)
    .then(function(r) {
      if (!r.ok) throw new Error('Function error ' + r.status);
      return r.json();
    })
    .then(function(json) {
      return parseYahoo(sym, json);
    });
}

function parseYahoo(sym, json) {
  if (json.error) throw new Error(json.error);
  var res = json.chart && json.chart.result && json.chart.result[0];
  if (!res) throw new Error('No data from Yahoo');
  var m = res.meta || {};
  var q = (res.indicators && res.indicators.quote && res.indicators.quote[0]) || {};
  var closes = (q.close || []).filter(function(v) { return v != null; });
  var price = m.regularMarketPrice || (closes.length ? closes[closes.length-1] : null);
  var prev  = m.chartPreviousClose || (closes.length >= 2 ? closes[closes.length-2] : null);
  if (!price) throw new Error('No price returned');
  return {
    sym:   sym,
    name:  m.shortName || m.longName || sym,
    price: price,
    prev:  prev,
    pch:   (price && prev) ? (price - prev) / prev * 100 : null,
    hi52:  m.fiftyTwoWeekHigh  || null,
    lo52:  m.fiftyTwoWeekLow   || null,
    mcap:  m.marketCap ? m.marketCap / 1e7 : null,
    err:   null
  };
}

// ─────────────────────────────────────────
// ADD & FETCH
// ─────────────────────────────────────────
function addAndFetch() {
  var raw = document.getElementById('tickerInput').value.trim();
  if (!raw) { showToast('Type tickers first', 'err'); return; }
  var syms = parseTickers(raw);
  if (!syms.length) { showToast('No valid tickers', 'err'); return; }

  var added = [];
  var n = dbNextN();
  var today = new Date().toISOString().slice(0, 10);
  for (var i = 0; i < syms.length; i++) {
    if (!dbHas(syms[i])) {
      tickerDb.push({ n: n++, sym: syms[i], added: today });
      added.push(syms[i]);
    }
  }
  dbSave();
  document.getElementById('tickerInput').value = '';
  renderDb();

  if (!added.length) { showToast('All already in DB', ''); return; }
  showToast(added.length + ' added — fetching prices...', 'ok');
  fetchSymbols(added);
}

function refreshAll() {
  if (!tickerDb.length) return;
  var syms = tickerDb.map(function(t) { return t.sym; });
  showToast('Refreshing ' + syms.length + ' prices...', '');
  fetchSymbols(syms);
}

// ─────────────────────────────────────────
// FETCH SYMBOLS — parallel, live updates
// ─────────────────────────────────────────
function fetchSymbols(syms) {
  showStatusBar();
  setProgress(0, syms.length);
  var done = 0;

  syms.forEach(function(sym) {
    // Show loading row immediately
    tableData[sym] = { sym: sym, loading: true };
    renderTable();

    fetchPrice(sym)
      .then(function(d) {
        tableData[sym] = d;
      })
      .catch(function(e) {
        tableData[sym] = { sym: sym, name: sym, err: e.message || 'Failed', loading: false };
      })
      .finally(function() {
        done++;
        setProgress(done, syms.length);
        updateStats();
        renderTable();
        if (done === syms.length) {
          document.getElementById('lastUpd').textContent = 'Updated: ' + new Date().toLocaleTimeString('en-IN');
          showToast('Done — ' + syms.length + ' prices loaded', 'ok');
        }
      });
  });
}

// ─────────────────────────────────────────
// RENDER TABLE
// ─────────────────────────────────────────
function renderTable() {
  var syms = tickerDb.map(function(t) { return t.sym; });
  if (!syms.length) {
    document.getElementById('mainTable').style.display = 'none';
    document.getElementById('emptyMsg').style.display = 'block';
    return;
  }
  document.getElementById('mainTable').style.display = '';
  document.getElementById('emptyMsg').style.display = 'none';

  var h = '';
  for (var i = 0; i < syms.length; i++) {
    var sym = syms[i];
    var d = tableData[sym];
    var dispSym = sym.replace('.NS','').replace('.BO','');
    var exchTag = sym.indexOf('.BO') >= 0 ? '.BO' : '.NS';

    if (!d) {
      // Not yet fetched
      h += '<tr><td><span class="sym">' + dispSym + '</span><span class="exch-tag">' + exchTag + '</span></td>'
         + '<td colspan="6" class="loading">waiting...</td></tr>';
    } else if (d.loading) {
      h += '<tr><td><span class="sym">' + dispSym + '</span><span class="exch-tag">' + exchTag + '</span></td>'
         + '<td colspan="6" class="loading">fetching...</td></tr>';
    } else if (d.err) {
      h += '<tr><td><span class="sym">' + dispSym + '</span><span class="exch-tag">' + exchTag + '</span></td>'
         + '<td colspan="6" class="err-msg">' + esc(d.err) + '</td></tr>';
    } else {
      var pchHtml = d.pch == null ? '<span class="mu">-</span>'
        : '<span class="' + (d.pch >= 0 ? 'up' : 'dn') + '">' + (d.pch >= 0 ? '+' : '') + d.pch.toFixed(2) + '%</span>';
      h += '<tr>'
        + '<td><span class="sym">' + dispSym + '</span><span class="exch-tag">' + exchTag + '</span></td>'
        + '<td class="name-cell">' + esc(d.name || '-') + '</td>'
        + '<td class="price">₹ ' + (d.price ? d.price.toLocaleString('en-IN', {minimumFractionDigits:2,maximumFractionDigits:2}) : '-') + '</td>'
        + '<td>' + pchHtml + '</td>'
        + '<td class="mu">' + (d.hi52 ? '₹ ' + d.hi52.toLocaleString('en-IN', {maximumFractionDigits:2}) : '-') + '</td>'
        + '<td class="mu">' + (d.lo52 ? '₹ ' + d.lo52.toLocaleString('en-IN', {maximumFractionDigits:2}) : '-') + '</td>'
        + '<td class="mu">' + (d.mcap ? fCr(d.mcap) : '-') + '</td>'
        + '</tr>';
    }
  }
  document.getElementById('tbody').innerHTML = h;
}

function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function fCr(v) {
  if (!v) return '-';
  if (v >= 1e5) return (v/1e5).toFixed(1) + ' LCr';
  if (v >= 1e3) return (v/1e3).toFixed(1) + ' KCr';
  return v.toFixed(0) + ' Cr';
}

// ─────────────────────────────────────────
// CLEAR TABLE (keeps DB)
// ─────────────────────────────────────────
function clearAll() {
  tableData = {};
  renderTable();
  document.getElementById('statusBar').className = '';
  showToast('Table cleared (DB intact)', '');
}

// ─────────────────────────────────────────
// STATUS BAR
// ─────────────────────────────────────────
function showStatusBar() {
  document.getElementById('statusBar').className = 'on';
}
function setProgress(done, total) {
  document.getElementById('progText').textContent = done + ' / ' + total;
}
function updateStats() {
  var all = Object.values(tableData);
  var ok  = all.filter(function(d) { return d && !d.err && !d.loading && d.price; }).length;
  var err = all.filter(function(d) { return d && d.err; }).length;
  document.getElementById('sTot').textContent = tickerDb.length;
  document.getElementById('sOk').textContent  = ok;
  document.getElementById('sErr').textContent = err;
}

// ─────────────────────────────────────────
// TOAST
// ─────────────────────────────────────────
var _toastTimer;
function showToast(msg, type) {
  var el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'show' + (type ? ' ' + type : '');
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(function() { el.className = ''; }, 3000);
}

// ─────────────────────────────────────────
// INIT
// ─────────────────────────────────────────
dbLoad();
renderDb();
renderTable();
</script>
</body>
</html>
