<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StockPulse</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');
:root{
  --bg:#070b14;--bg2:#0d1220;--bg3:#111827;--bg4:#162032;
  --border:#1e2d45;--border2:#243550;
  --text:#e2e8f4;--mu:#4a6080;--mu2:#6b84a0;
  --acc:#f59e0b;--acc2:#fbbf24;
  --green:#10d98a;--green2:#34d399;
  --red:#f43f60;--red2:#fb7185;
  --blue:#3b82f6;--purple:#8b5cf6;--cyan:#06b6d4;
  --font:'Inter',sans-serif;--mono:'JetBrains Mono',monospace;
  --radius:6px;--shadow:0 4px 24px rgba(0,0,0,.4);
}
/* ‚îÄ‚îÄ LIGHT THEME ‚îÄ‚îÄ */
body.light{
  --bg:#f1f5fb;--bg2:#ffffff;--bg3:#e8edf6;--bg4:#dde4f0;
  --border:#cdd5e8;--border2:#b8c4da;
  --text:#0f172a;--mu:#64748b;--mu2:#94a3b8;
  --acc:#d97706;--acc2:#f59e0b;
  --green:#059669;--green2:#10b981;
  --red:#dc2626;--red2:#ef4444;
}
body.light #topbar{background:linear-gradient(135deg,#1e3a5f,#0f2a4a);}
body.light #topbar *{color:#e2e8f4!important;}
body.light thead tr.hg1 th{background:#dde4f2;}
body.light thead tr.hg2 th{background:#eef1f9;}
body.light thead tr.hg3 th{background:#e4e9f4;}
body.light tbody tr:hover{background:#edf2fb;}
body.light td{border-right-color:#e2e8f4;border-bottom-color:#e8edf6;}
body.light .frz td:nth-child(1),body.light .frz td:nth-child(2),body.light .frz td:nth-child(3){background:#f1f5fb;}
body.light .frz tbody tr:hover td:nth-child(1),body.light .frz tbody tr:hover td:nth-child(2),body.light .frz tbody tr:hover td:nth-child(3){background:#edf2fb;}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:var(--font);font-size:13px;line-height:1.5;}
#topbar{display:flex;align-items:center;gap:14px;padding:12px 20px;background:linear-gradient(135deg,#0d1f3c 0%,#071428 100%);border-bottom:1px solid rgba(245,158,11,.15);box-shadow:0 2px 20px rgba(0,0,0,.5);}
#logo{font-size:16px;font-weight:700;letter-spacing:2px;font-family:var(--mono);background:linear-gradient(135deg,var(--acc),var(--acc2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
#logo span{background:inherit;-webkit-background-clip:text;background-clip:text;}
#arInfo{font-size:11px;color:var(--green);margin-left:6px;}
#lastUpd{margin-left:auto;font-size:11px;color:var(--mu2);font-family:var(--mono);letter-spacing:.3px;}
#inp{display:flex;gap:14px;align-items:flex-start;padding:14px 20px;background:var(--bg2);border-bottom:1px solid var(--border);flex-wrap:wrap;}
textarea{background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:12px;padding:8px 10px;border-radius:4px;resize:none;width:200px;height:80px;outline:none;}
textarea:focus{border-color:var(--acc);}
.eb{background:var(--bg3);border:1px solid var(--border);color:var(--mu);font-family:inherit;font-size:11px;padding:5px 12px;border-radius:4px;cursor:pointer;display:block;margin-bottom:6px;width:100px;}
.eb.on{border-color:var(--acc);color:var(--acc);}
.btn{background:transparent;border:1px solid var(--border2);color:var(--text);font-family:inherit;font-size:12px;padding:8px 16px;border-radius:var(--radius);cursor:pointer;display:block;width:190px;margin-bottom:6px;text-align:left;transition:all .15s;letter-spacing:.3px;}
.btn:hover{border-color:var(--acc);color:var(--acc);background:rgba(245,158,11,.06);transform:translateX(1px);}
.btn.pri{background:linear-gradient(135deg,var(--acc),var(--acc2));border-color:var(--acc);color:#000;font-weight:700;box-shadow:0 2px 12px rgba(245,158,11,.35);}
.btn.pri:hover{background:linear-gradient(135deg,var(--acc2),#fcd34d);box-shadow:0 4px 18px rgba(245,158,11,.5);transform:translateY(-1px);}
.btn:disabled{opacity:.4;cursor:not-allowed;}
#arSel{background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:11px;padding:5px 8px;border-radius:4px;cursor:pointer;outline:none;width:190px;margin-bottom:6px;}
#dbpanel{padding:8px 16px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-wrap:wrap;min-height:38px;}
#dblabel{font-size:11px;color:var(--mu);white-space:nowrap;}
.chip{display:inline-flex;align-items:center;gap:5px;background:var(--bg3);border:1px solid var(--border);border-radius:3px;padding:2px 7px;font-size:11px;margin:2px;}
.cn{color:var(--mu);font-size:10px;}
.cx{cursor:pointer;color:var(--mu);}
.cx:hover{color:var(--red);}
#toolbar{display:flex;align-items:center;gap:10px;padding:8px 20px;background:var(--bg2);border-bottom:1px solid var(--border);flex-wrap:wrap;}
#searchBox{background:var(--bg3);border:1px solid var(--border2);color:var(--text);font-family:var(--font);font-size:12px;padding:6px 12px;border-radius:var(--radius);outline:none;width:240px;}
#searchBox:focus{border-color:var(--acc);box-shadow:0 0 0 2px rgba(245,158,11,.12);}
.tbtn{background:transparent;border:1px solid var(--border2);color:var(--mu2);font-family:inherit;font-size:11px;padding:5px 12px;border-radius:var(--radius);cursor:pointer;transition:all .15s;letter-spacing:.2px;}
.tbtn:hover{border-color:var(--acc);color:var(--acc);background:rgba(245,158,11,.06);}
.tbtn.on{border-color:var(--acc);color:var(--acc);background:rgba(245,158,11,.1);}
#freezeBtn.on{border-color:#4af;color:#4af;background:rgba(68,170,255,.07);}
#cacheNote{font-size:10px;color:var(--mu);margin-left:auto;}
#cacheNote a{color:var(--acc);text-decoration:none;}
/* ALERT PANEL */
#alertPanel{display:none;padding:8px 16px;background:rgba(240,165,0,.05);border-bottom:2px solid rgba(240,165,0,.3);align-items:flex-start;gap:8px;flex-wrap:wrap;}
#alertPanel.on{display:flex;}
#alertLabel{font-size:10px;font-weight:700;color:var(--acc);white-space:nowrap;padding-top:2px;}
#alertItems{display:flex;gap:6px;flex-wrap:wrap;flex:1;}
.al{font-size:11px;padding:3px 8px;border-radius:3px;background:var(--bg3);border:1px solid var(--border);}
.al-bull{border-color:var(--green);color:var(--green);}
.al-bear{border-color:var(--red);color:var(--red);}
.al-brk{border-color:var(--acc);color:var(--acc);}
.al-vol{border-color:#4af;color:#4af;}
.al-phase{border-color:#a0a;color:#d8d;}
.al-coil{border-color:#f8f;color:#faf;}
.al-cross{border-color:#0ff;color:#0dd;}
#sbar{display:none;padding:5px 16px;background:var(--bg2);border-bottom:1px solid var(--border);font-size:11px;color:var(--mu);gap:14px;align-items:center;}
#sbar.on{display:flex;}
.sv{color:var(--text);font-weight:600;}
.g{color:var(--green);}.r{color:var(--red);}
/* TABLE */
#twrap{overflow:auto;}
table{width:100%;border-collapse:separate;border-spacing:0;}
thead tr.hg1 th{background:#08111e;position:sticky;top:0;z-index:12;padding:6px 12px;font-size:9px;color:var(--mu2);font-weight:700;letter-spacing:1px;white-space:nowrap;text-align:center;border-right:1px solid var(--border);border-bottom:1px solid var(--border);text-transform:uppercase;}
thead tr.hg2 th{background:#0a1628;position:sticky;top:27px;z-index:11;padding:7px 14px;text-align:center;font-size:9px;color:var(--mu2);font-weight:600;letter-spacing:.6px;border-bottom:2px solid var(--border2);white-space:nowrap;border-right:1px solid var(--border);cursor:pointer;user-select:none;min-width:80px;}
thead tr.hg2 th:hover{color:var(--acc);background:#0d1e34;}
.sort-asc::after{content:' ‚ñ≤';color:var(--acc);font-size:8px;}
.sort-desc::after{content:' ‚ñº';color:var(--acc);font-size:8px;}
tbody tr{border-bottom:1px solid var(--border);transition:background .1s;}
tbody tr:hover{background:rgba(59,130,246,.06);}
td{padding:8px 14px;font-size:12px;white-space:nowrap;text-align:center;border-right:1px solid var(--border);border-bottom:1px solid var(--border);font-family:var(--mono);}
.sym{font-weight:700;font-size:13px;}
.xt{font-size:9px;color:var(--mu);margin-left:2px;}
.nc{color:var(--mu);font-size:11px;max-width:120px;overflow:hidden;text-overflow:ellipsis;display:inline-block;vertical-align:middle;}
.ni{color:#7070aa;font-size:10px;max-width:110px;overflow:hidden;text-overflow:ellipsis;display:inline-block;vertical-align:middle;}
.up{color:var(--green);}.dn{color:var(--red);}.mu{color:var(--mu);}
.ld{color:var(--mu);font-style:italic;font-size:11px;}
.er{color:var(--red);font-size:11px;}
.wl-col{width:36px;background:rgba(255,255,255,.025);border-right:2px solid var(--border2)!important;text-align:center;padding:6px 2px!important;}
.wl-col-hd{width:36px;background:rgba(255,255,255,.025)!important;border-right:2px solid var(--border2)!important;font-size:9px;color:var(--mu2);letter-spacing:.5px;}
.star{cursor:pointer;font-size:14px;color:var(--mu);user-select:none;}
.star:hover{color:var(--acc);}.star.on{color:var(--acc);}
.yes{font-weight:600;font-size:10px;background:rgba(16,217,138,.12);color:var(--green);border-radius:4px;padding:2px 8px;letter-spacing:.5px;border:1px solid rgba(16,217,138,.2);}
.no{font-weight:600;font-size:10px;background:rgba(244,63,96,.09);color:var(--red);border-radius:4px;padding:2px 8px;letter-spacing:.5px;border:1px solid rgba(244,63,96,.15);}
.streak-up{color:var(--green);font-size:11px;}
.streak-dn{color:var(--red);font-size:11px;}
.streak-0{color:var(--mu);font-size:11px;}
.ev{font-size:11px;color:#aaa;}
.pct-hi{font-size:10px;color:var(--red);}
.pct-lo{font-size:10px;color:var(--green);}
.pct-ath{font-size:10px;color:var(--mu);}
.sec-border{border-left:2px solid var(--border)!important;}
/* Signal tags */
.t-bull{font-size:10px;font-weight:700;padding:2px 6px;border-radius:3px;background:rgba(0,214,143,.15);color:var(--green);}
.t-bear{font-size:10px;font-weight:700;padding:2px 6px;border-radius:3px;background:rgba(255,68,102,.13);color:var(--red);}
.t-mix{font-size:10px;font-weight:700;padding:2px 6px;border-radius:3px;background:rgba(240,165,0,.12);color:var(--acc);}
.t-s1{font-size:10px;font-weight:700;padding:2px 5px;border-radius:3px;background:rgba(120,120,220,.13);color:#99f;}
.t-s2{font-size:10px;font-weight:700;padding:2px 5px;border-radius:3px;background:rgba(0,214,143,.15);color:var(--green);}
.t-s3{font-size:10px;font-weight:700;padding:2px 5px;border-radius:3px;background:rgba(240,165,0,.15);color:var(--acc);}
.t-s4{font-size:10px;font-weight:700;padding:2px 5px;border-radius:3px;background:rgba(255,68,102,.13);color:var(--red);}
.t-coil{font-size:10px;font-weight:700;padding:2px 5px;border-radius:3px;background:rgba(255,100,255,.12);color:#f8f;}
.t-brk52{font-size:9px;font-weight:700;padding:1px 4px;border-radius:2px;margin-left:3px;background:rgba(240,165,0,.18);color:var(--acc);}
.t-brkdn{font-size:9px;font-weight:700;padding:1px 4px;border-radius:2px;margin-left:3px;background:rgba(255,68,102,.18);color:var(--red);}
.t-spike{font-size:9px;font-weight:700;padding:1px 4px;border-radius:2px;margin-left:3px;background:rgba(68,170,255,.18);color:#4af;}
/* 200 EMA cross tags */
.t-cup{font-size:9px;font-weight:700;padding:1px 5px;border-radius:2px;background:rgba(0,255,200,.15);color:#0ff;}
.t-cdn{font-size:9px;font-weight:700;padding:1px 5px;border-radius:2px;background:rgba(255,60,60,.15);color:#f66;}
.ema-sig{display:inline-block;font-size:8px;font-weight:700;padding:1px 4px;border-radius:2px;margin:1px 1px 0;}
.ema-sig-up{background:rgba(0,214,143,.2);color:var(--green);border:1px solid rgba(0,214,143,.4);}
.ema-sig-dn{background:rgba(255,68,102,.15);color:var(--red);border:1px solid rgba(255,68,102,.35);}
.vr-hot{color:#f90;font-size:10px;font-weight:700;}
.vr-norm{color:var(--mu);font-size:10px;}
/* Volume */
.vol-hi{color:var(--green);font-size:11px;font-weight:600;}
.vol-lo{color:var(--mu);font-size:11px;}
.vol-tag{font-size:9px;font-weight:700;padding:1px 4px;border-radius:2px;margin-left:3px;background:rgba(0,214,143,.18);color:var(--green);}
/* Freeze ‚Äî freeze star + ticker + name (3 cols) */
.frz td:nth-child(1),.frz td:nth-child(2),.frz td:nth-child(3){position:sticky;z-index:4;background:var(--bg);}
.frz td:nth-child(1){left:0;}
.frz td:nth-child(2){left:30px;}
.frz td:nth-child(3){left:130px;border-right:2px solid var(--border);}
.frz tbody tr:hover td:nth-child(1),.frz tbody tr:hover td:nth-child(2),.frz tbody tr:hover td:nth-child(3){background:#111119;}
.frz thead tr.hg1 th:nth-child(1),.frz thead tr.hg1 th:nth-child(2){position:sticky;z-index:14;background:#0d0d14;}
.frz thead tr.hg1 th:nth-child(1){left:0;}
.frz thead tr.hg1 th:nth-child(2){left:30px;}
.frz thead tr.hg2 th:nth-child(1){position:sticky;left:0;z-index:13;background:var(--bg2);}
.frz thead tr.hg2 th:nth-child(2){position:sticky;left:30px;z-index:13;background:var(--bg2);}
.frz thead tr.hg2 th:nth-child(3){position:sticky;left:130px;z-index:13;background:var(--bg2);border-right:2px solid var(--border);}
#empty{text-align:center;padding:60px;color:var(--mu);}
/* FILTER ROW */
thead tr.hg3 th{background:#081525;position:sticky;top:55px;z-index:10;padding:4px 6px;border-bottom:2px solid rgba(245,158,11,.5);border-right:1px solid var(--border);white-space:nowrap;min-width:80px;}
.fi{background:var(--bg3);border:1px solid var(--border2);color:var(--text);font-family:var(--mono);font-size:10px;padding:3px 6px;border-radius:4px;outline:none;width:100%;box-sizing:border-box;}
.fi:focus{border-color:var(--acc);}
.fi-sel{background:var(--bg3);border:1px solid var(--border2);color:var(--text);font-family:var(--font);font-size:10px;padding:3px 5px;border-radius:4px;outline:none;width:100%;cursor:pointer;min-width:0;}
.fi-sel:focus,.fi-sel.act{border-color:var(--acc);color:var(--acc);}
.fi-rng{display:flex;gap:2px;align-items:center;}
.fi-rng input{background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:10px;padding:2px 4px;border-radius:3px;outline:none;width:48%;min-width:0;}
.fi-rng input:focus{border-color:var(--acc);}
.fi-rng input.act{border-color:var(--acc);color:var(--acc);}
.fi-rng span{color:var(--mu);font-size:9px;}
/* Active filter count badge */
#fBadge{font-size:10px;font-weight:700;color:var(--acc);background:rgba(240,165,0,.12);border:1px solid rgba(240,165,0,.3);border-radius:3px;padding:1px 6px;margin-left:6px;display:none;}
/* frz filter row sticky */
.frz thead tr.hg3 th:nth-child(1){position:sticky;left:0;z-index:15;background:#0c0c13;}
.frz thead tr.hg3 th:nth-child(2){position:sticky;left:30px;z-index:15;background:#0c0c13;}
.frz thead tr.hg3 th:nth-child(3){position:sticky;left:130px;z-index:15;background:#0c0c13;border-right:2px solid var(--border);}
#wlEmpty{display:none;text-align:center;padding:60px;color:var(--mu);}
#toast{position:fixed;bottom:20px;right:20px;background:var(--bg3);border:1px solid var(--border);padding:10px 16px;border-radius:4px;font-size:12px;opacity:0;transition:opacity .2s;pointer-events:none;z-index:999;}
#toast.show{opacity:1;}
#toast.ok{border-color:var(--green);color:var(--green);}
#toast.er{border-color:var(--red);color:var(--red);}
/* hidden file input */
#fileImport{display:none;}
/* SMART FILTER BAR */
#smartBar{display:flex;align-items:center;gap:10px;padding:10px 20px;background:#07111f;border-bottom:2px solid rgba(245,158,11,.2);flex-wrap:wrap;}
.sb-label{font-size:9px;font-weight:700;letter-spacing:1px;color:var(--acc);white-space:nowrap;opacity:.7;}
.sb-group{display:flex;flex-direction:column;gap:2px;}
.sb-grouplabel{font-size:8px;font-weight:600;letter-spacing:.6px;color:var(--mu);text-transform:uppercase;}
.sb-sel{background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:11px;padding:5px 10px;border-radius:4px;cursor:pointer;outline:none;min-width:150px;}
.sb-sel:focus,.sb-sel.act{border-color:var(--acc);color:var(--acc);}
.sb-preset{background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.3);color:var(--acc);font-family:var(--font);font-size:11px;font-weight:600;padding:7px 16px;border-radius:var(--radius);cursor:pointer;white-space:nowrap;transition:all .2s;letter-spacing:.3px;}
.sb-preset:hover,.sb-preset.on{background:rgba(245,158,11,.15);border-color:var(--acc2);}
.sb-preset.on{box-shadow:0 0 12px rgba(245,158,11,.3);}
.sb-clear{background:transparent;border:1px solid rgba(255,68,102,.3);color:var(--red);font-family:inherit;font-size:10px;padding:5px 12px;border-radius:4px;cursor:pointer;margin-left:auto;}
.sb-clear:hover{background:rgba(255,68,102,.08);}
/* SLIM DB BAR */
#dbbar{display:flex;align-items:center;gap:8px;padding:6px 16px;background:var(--bg2);border-bottom:1px solid var(--border);}
/* MODAL */
#modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;align-items:flex-start;justify-content:center;padding-top:60px;}
#modal.on{display:flex;}
#modalBox{background:var(--bg2);border:1px solid var(--border);border-radius:6px;width:min(900px,95vw);max-height:80vh;display:flex;flex-direction:column;overflow:hidden;}
#modalHead{display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);background:var(--bg3);}
#modalBody{overflow-y:auto;flex:1;}
.mrow{display:flex;align-items:center;gap:10px;padding:7px 16px;border-bottom:1px solid #16161e;font-size:12px;}
.mrow:hover{background:#111119;}
.mrow-num{color:var(--mu);font-size:10px;min-width:28px;}
.mrow-sym{font-weight:700;min-width:110px;}
.mrow-name{color:var(--mu);font-size:11px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.mrow-ind{color:#7070aa;font-size:10px;min-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.mrow-status{min-width:90px;text-align:center;}
.ms-ok{font-size:10px;font-weight:700;color:var(--green);background:rgba(0,214,143,.1);border-radius:3px;padding:1px 6px;}
.ms-err{font-size:10px;font-weight:700;color:var(--red);background:rgba(255,68,102,.1);border-radius:3px;padding:1px 6px;}
.ms-load{font-size:10px;color:var(--acc);font-style:italic;}
.ms-new{font-size:10px;color:var(--mu);font-style:italic;}
.mrow-del{margin-left:auto;background:transparent;border:1px solid rgba(255,68,102,.3);color:var(--red);font-size:10px;padding:2px 8px;border-radius:3px;cursor:pointer;font-family:inherit;}
.mrow-del:hover{background:rgba(255,68,102,.12);}

/* THEME TOGGLE */
#themeBtn{background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:11px;padding:4px 10px;border-radius:20px;cursor:pointer;margin-left:8px;user-select:none;}
#themeBtn:hover{border-color:var(--acc);}
/* COLUMN VISIBILITY PANEL */
#colVisBtn{background:transparent;border:1px solid var(--border);color:var(--mu);font-family:inherit;font-size:11px;padding:5px 12px;border-radius:4px;cursor:pointer;}
#colVisBtn:hover{border-color:var(--acc);color:var(--acc);}
#colVisPanel{display:none;position:fixed;top:0;right:0;width:260px;height:100vh;background:var(--bg2);border-left:2px solid var(--border);z-index:300;overflow-y:auto;box-shadow:-4px 0 20px rgba(0,0,0,.4);}
#colVisPanel.on{display:block;}
#colVisHead{padding:12px 16px;background:var(--bg3);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-size:12px;font-weight:700;}
.cvg{padding:10px 16px;border-bottom:1px solid var(--border);}
.cvg-label{font-size:9px;font-weight:700;letter-spacing:.8px;color:var(--acc);text-transform:uppercase;margin-bottom:6px;}
.cvc{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:11px;cursor:pointer;}
.cvc input[type=checkbox]{accent-color:var(--acc);width:13px;height:13px;cursor:pointer;}
.cvc:hover{color:var(--acc);}
/* Stronger 52W color ‚Äî very close or very far */
.pct-hi-close{font-size:10px;color:#ff8800;font-weight:700;}  /* < 1% from high = hot */
.pct-hi-far{font-size:10px;color:#aa2244;}                    /* > 30% from high = deep */
.pct-lo-close{font-size:10px;color:#00ffaa;font-weight:700;}  /* < 5% from low = danger */
.pct-lo-far{font-size:10px;color:#00aa66;}                    /* > 80% from low = strong */
/* pullback days tag */
.pb-tag{font-size:8px;color:var(--mu);display:block;margin-top:1px;}
.pb-tag.warn{color:var(--acc);}
.pb-tag.ok{color:var(--green);}
/* Composite Score badge */
.score-hi{font-size:11px;font-weight:700;color:#000;background:linear-gradient(135deg,#f0a500,#ffcc44);border-radius:4px;padding:2px 6px;min-width:28px;display:inline-block;text-align:center;}
.score-mid{font-size:11px;font-weight:700;color:var(--green);background:rgba(0,214,143,.15);border-radius:4px;padding:2px 6px;}
.score-lo{font-size:11px;color:var(--mu);background:rgba(255,255,255,.05);border-radius:4px;padding:2px 6px;}
/* NR7 tag */
.t-nr7{font-size:9px;font-weight:700;padding:1px 5px;border-radius:2px;background:rgba(180,100,255,.2);color:#c88fff;border:1px solid rgba(180,100,255,.4);}
/* Consecutive days */
.consec-up{color:var(--green);font-size:11px;font-weight:600;}
.consec-dn{color:var(--red);font-size:11px;font-weight:600;}
/* Volume dry-up */
.t-vdu{font-size:9px;font-weight:700;padding:1px 4px;border-radius:2px;background:rgba(68,100,255,.18);color:#88aaff;}
/* RS vs Nifty */
.rs-hi{color:var(--green);font-size:11px;font-weight:600;}
.rs-lo{color:var(--red);font-size:11px;}
.rs-mid{color:var(--mu);font-size:11px;}
/* Return cells */
.ret-hi{color:var(--green);font-size:11px;font-weight:600;}
.ret-lo{color:var(--red);font-size:11px;}
.ret-mid{color:var(--mu);font-size:11px;}
/* ADR / AWR cells */
.adr-tight{color:var(--green);font-size:11px;font-weight:600;}
.adr-mid{color:var(--mu);font-size:11px;}
.adr-wide{color:var(--red);font-size:11px;}
/* Weekly EMA conditions */
.wyes{font-weight:700;font-size:10px;background:rgba(0,214,143,.1);color:var(--green);border-radius:3px;padding:1px 5px;}
.wno{font-weight:700;font-size:10px;background:rgba(255,68,102,.09);color:var(--red);border-radius:3px;padding:1px 5px;}
/* hidden column utility */
.col-hidden{display:none!important;}
/* PAGINATION */
#paginationBar{display:none;align-items:center;justify-content:space-between;padding:10px 20px;background:var(--bg2);border-top:1px solid var(--border);flex-wrap:wrap;gap:8px;}
#paginationBar.on{display:flex;}
.pg-info{font-size:11px;color:var(--mu2);font-family:var(--mono);}
.pg-info strong{color:var(--acc);}
.pg-controls{display:flex;align-items:center;gap:4px;}
.pg-btn{background:var(--bg3);border:1px solid var(--border2);color:var(--mu2);font-family:var(--mono);font-size:11px;padding:4px 10px;border-radius:var(--radius);cursor:pointer;transition:all .15s;min-width:34px;text-align:center;}
.pg-btn:hover{border-color:var(--acc);color:var(--acc);}
.pg-btn.on{background:var(--acc);border-color:var(--acc);color:#000;font-weight:700;}
.pg-btn:disabled{opacity:.3;cursor:default;}
.pg-size{background:var(--bg3);border:1px solid var(--border2);color:var(--text);font-family:var(--font);font-size:11px;padding:4px 8px;border-radius:var(--radius);cursor:pointer;outline:none;}
/* ROW UPDATED HIGHLIGHT */
tbody tr.row-updated{position:relative;}
tbody tr.row-updated td:first-child::before{content:'‚Üª';position:absolute;left:2px;top:50%;transform:translateY(-50%);font-size:8px;color:var(--green);opacity:.7;}
/* FOOTER */
#footer{padding:20px 20px 30px;text-align:center;background:#070b14;border-top:1px solid var(--border);margin-top:0;}
body.light #footer{background:#e8edf6;}
.footer-inner{max-width:900px;margin:0 auto;}
.footer-logo{font-family:var(--mono);font-size:18px;font-weight:700;background:linear-gradient(135deg,var(--acc),var(--acc2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:2px;margin-bottom:8px;}
.footer-tagline{font-size:11px;color:var(--mu2);margin-bottom:16px;letter-spacing:.5px;}
.footer-links{display:flex;gap:20px;justify-content:center;flex-wrap:wrap;margin-bottom:16px;}
.footer-links a{color:var(--mu2);font-size:11px;text-decoration:none;transition:color .15s;letter-spacing:.3px;}
.footer-links a:hover{color:var(--acc);}
.footer-divider{width:60px;height:1px;background:linear-gradient(90deg,transparent,var(--acc),transparent);margin:14px auto;}
.footer-copy{font-size:10px;color:var(--mu);letter-spacing:.3px;}
.footer-disclaimer{font-size:10px;color:var(--mu);margin-top:8px;opacity:.7;max-width:600px;margin-left:auto;margin-right:auto;line-height:1.6;}
/* STICKY SCROLLBAR */
#hscroll{overflow-x:auto;overflow-y:hidden;height:14px;background:var(--bg2);border-bottom:1px solid var(--border);position:sticky;top:48px;z-index:9;}
#hscrollInner{height:1px;}
</style>
<!-- Fonts loaded via CSS @import -->
</head>
<body>

<div id="topbar">
  <div id="logo">STOCK<span>PULSE</span>.IN</div>
  <div style="color:var(--mu);font-size:11px">// NSE BSE Momentum Terminal</div>
  <span id="arInfo"></span>
  <div id="lastUpd">‚Äî</div>
  <button id="themeBtn" onclick="toggleTheme()">‚òÄ Light</button>
</div>

<div id="inp">
  <div>
    <div style="font-size:10px;color:var(--mu);margin-bottom:4px">ADD TICKERS <span id="dbc" style="color:var(--acc)">DB:0</span></div>
    <textarea id="ti" placeholder="RELIANCE&#10;TCS&#10;INFY"></textarea>
  </div>
  <div>
    <div style="font-size:10px;color:var(--mu);margin-bottom:4px">EXCHANGE</div>
    <button class="eb on" id="bns" onclick="setX('NS')">NSE (.NS)</button>
    <button class="eb" id="bbo" onclick="setX('BO')">BSE (.BO)</button>
  </div>
  <div style="padding-top:18px;">
    <button class="btn pri" onclick="addFetch()">+ Add &amp; Fetch</button>
    <button class="btn" id="rbtn" onclick="refreshAll()" disabled>‚ü≥ Refresh All</button>
    <button class="btn" onclick="clearT()">‚úï Clear Table</button>
  </div>
  <div style="padding-top:18px;">
    <div style="font-size:10px;color:var(--mu);margin-bottom:4px">IMPORT LIST</div>
    <button class="btn" onclick="document.getElementById('fileImport').click()">‚Üë Import CSV / Excel</button>
    <input type="file" id="fileImport" accept=".csv,.xlsx,.xls" onchange="importFile(this)">
    <div style="font-size:9px;color:var(--mu);margin-top:-2px;margin-bottom:6px">Cols: Ticker, Name, Industry</div>
    <button class="btn" onclick="exportCSV()">‚Üì Export CSV</button>
    <button class="btn" onclick="exportExcel()">‚Üì Export Excel</button>
  </div>
  <div style="padding-top:18px;">
    <div style="font-size:10px;color:var(--mu);margin-bottom:4px">AUTO REFRESH</div>
    <select id="arSel" onchange="setAutoRefresh()">
      <option value="0">Off</option>
      <option value="60" selected>Every 1 Hour</option>
      <option value="30">Every 30 Min</option>
      <option value="15">Every 15 Min</option>
    </select>
  </div>
</div>

<!-- SLIM DB BAR -->
<div id="dbbar">
  <span style="font-size:11px;color:var(--mu)">MY STOCKS <span id="dbCount" style="color:var(--acc);font-weight:700">0</span></span>
  <span id="errBadge" style="display:none;font-size:10px;font-weight:700;color:var(--red);background:rgba(255,68,102,.12);border:1px solid var(--red);border-radius:3px;padding:1px 6px;margin-left:6px"></span>
  <button class="tbtn" onclick="openModal()" style="font-size:11px;padding:3px 10px">‚ò∞ Manage Stocks</button>
  <button class="tbtn" onclick="clearAllDB()" style="font-size:11px;padding:3px 10px;color:var(--red);border-color:rgba(255,68,102,.4)">‚úï Clear All</button>
</div>

<!-- STOCK MANAGER MODAL -->
<div id="modal" onclick="if(event.target===this)closeModal()">
  <div id="modalBox">
    <div id="modalHead">
      <span style="font-size:13px;font-weight:700;letter-spacing:.5px">STOCK MANAGER</span>
      <span id="modalStats" style="font-size:11px;color:var(--mu);margin-left:12px"></span>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
        <button class="tbtn" onclick="removeInvalid()" id="rmInvalidBtn" style="font-size:10px;padding:3px 10px;color:var(--red);border-color:rgba(255,68,102,.4);display:none">‚úï Remove All Invalid</button>
        <button class="tbtn" onclick="clearAllDB();closeModal()" style="font-size:10px;padding:3px 10px;color:var(--red);border-color:rgba(255,68,102,.4)">‚úï Clear All</button>
        <button class="tbtn" onclick="closeModal()" style="font-size:11px;padding:3px 10px">‚úï Close</button>
      </div>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<div id="toolbar">
  <input id="searchBox" type="text" placeholder="Search ticker / name / industry..." oninput="renderTbl()">
  <span id="fBadge" title="Active filters">0 filters</span>
  <button class="tbtn" onclick="clearAllFilters()" id="fClearBtn" style="display:none;font-size:10px;padding:3px 8px;color:var(--acc)">‚úï Clear Filters</button>
  <button id="wlToggle" class="tbtn" onclick="toggleWL()">‚òÜ Watchlist <span id="wlCount"></span></button>
  <button id="freezeBtn" class="tbtn" onclick="toggleFreeze()">‚ùÑ Freeze Cols</button>
  <button id="colVisBtn" onclick="toggleColVis()">‚äû Columns</button>
  <button class="tbtn" onclick="exportVisibleCSV()" style="font-size:10px;padding:3px 8px">‚Üì Export Visible</button>
  <span id="cacheNote"></span>
</div>

<!-- STICKY HORIZONTAL SCROLLBAR mirrors #twrap -->
<div id="hscroll"><div id="hscrollInner"></div></div>

<!-- SMART FILTER BAR -->
<div id="smartBar">
  <span class="sb-label">SMART FILTERS</span>

  <div class="sb-group">
    <span class="sb-grouplabel">% vs EMA20</span>
    <select class="sb-sel" id="sf_pullback" onchange="applyFilters()">
      <option value="">All</option>
      <option value="pullback1">Pullback 0% to -1%</option>
      <option value="pullback3">Pullback 0% to -3%</option>
      <option value="pullback5">Pullback 0% to -5%</option>
      <option value="above_ema20">Above EMA20</option>
      <option value="below_ema20">Below EMA20</option>
    </select>
  </div>

  <div class="sb-group">
    <span class="sb-grouplabel">Vol Ratio</span>
    <select class="sb-sel" id="sf_volratio" onchange="applyFilters()">
      <option value="">All</option>
      <option value="1.5">&gt; 1.5√ó Avg</option>
      <option value="2">&gt; 2√ó Avg</option>
      <option value="3">&gt; 3√ó Avg</option>
    </select>
  </div>

  <div class="sb-group">
    <span class="sb-grouplabel">52W Breakout</span>
    <select class="sb-sel" id="sf_bo52" onchange="applyFilters()">
      <option value="">All</option>
      <option value="near">Near High (&lt;2%)</option>
      <option value="at">At / Above High</option>
    </select>
  </div>

  <button class="sb-preset" id="presetS2Bull" onclick="applyPreset('s2bull')" title="TREND=BULL + PHASE=S2 + all 4 EMA conditions YES">
    üî• S2 + BULL Setup
  </button>
  <button class="sb-preset" id="presetMomentum" onclick="applyPreset('momentum')" title="BULL + S2 + Vol Ratio &gt;1.5x + P&gt;EMA20">
    ‚ö° Full Momentum
  </button>
  <button class="sb-preset" id="presetCoilBO" onclick="applyPreset('coilbo')" title="COIL + Near 52W High = compression at top">
    üåÄ Coil + Breakout
  </button>

  <button class="sb-clear" onclick="clearSmartFilters()" id="sfClearBtn" style="display:none">‚úï Clear Smart</button>
</div>

<!-- COLUMN VISIBILITY PANEL (slide-out) -->
<div id="colVisPanel">
  <div id="colVisHead">
    <span>‚äû COLUMN VISIBILITY</span>
    <button class="tbtn" onclick="toggleColVis()" style="padding:2px 8px;font-size:10px">‚úï</button>
  </div>
  <div class="cvg">
    <div class="cvg-label">Stock Info</div>
    <label class="cvc"><input type="checkbox" id="cv_industry" onchange="applyColVis()" checked> Industry</label>
  </div>
  <div class="cvg">
    <div class="cvg-label">Signal</div>
    <label class="cvc"><input type="checkbox" id="cv_trend" onchange="applyColVis()" checked> Trend</label>
    <label class="cvc"><input type="checkbox" id="cv_phase" onchange="applyColVis()" checked> Phase</label>
    <label class="cvc"><input type="checkbox" id="cv_coil" onchange="applyColVis()" checked> Coil / 5D Range</label>
  </div>
  <div class="cvg">
    <div class="cvg-label">Price &amp; Range</div>
    <label class="cvc"><input type="checkbox" id="cv_pch" onchange="applyColVis()" checked> % Day</label>
    <label class="cvc"><input type="checkbox" id="cv_mcap" onchange="applyColVis()" checked> MCap</label>
    <label class="cvc"><input type="checkbox" id="cv_52w" onchange="applyColVis()" checked> 52W High / Low</label>
    <label class="cvc"><input type="checkbox" id="cv_5yh" onchange="applyColVis()" checked> 5Y High</label>
    <label class="cvc"><input type="checkbox" id="cv_rng" onchange="applyColVis()" checked> 5D / 4W Range</label>
    <label class="cvc"><input type="checkbox" id="cv_adr" onchange="applyColVis()" checked> ADR / AWR</label>
    <label class="cvc"><input type="checkbox" id="cv_pb52" onchange="applyColVis()" checked> Days from 52W H/L</label>
  </div>
  <div class="cvg">
    <div class="cvg-label">EMA Values</div>
    <label class="cvc"><input type="checkbox" id="cv_ema_vals" onchange="applyColVis()" checked> EMA 20/50/100/200</label>
  </div>
  <div class="cvg">
    <div class="cvg-label">EMA Conditions (Daily)</div>
    <label class="cvc"><input type="checkbox" id="cv_ema_cond" onchange="applyColVis()" checked> 100&gt;200, 50&gt;100, 20&gt;50, P&gt;20</label>
  </div>
  <div class="cvg">
    <div class="cvg-label">EMA Conditions (Weekly)</div>
    <label class="cvc"><input type="checkbox" id="cv_wema" onchange="applyColVis()" checked> W: 100&gt;200, 50&gt;100, 20&gt;50, P&gt;20</label>
  </div>
  <div class="cvg">
    <div class="cvg-label">Days vs EMA</div>
    <label class="cvc"><input type="checkbox" id="cv_streaks" onchange="applyColVis()" checked> vs EMA 20/50/100/200</label>
  </div>
  <div class="cvg">
    <div class="cvg-label">Volume</div>
    <label class="cvc"><input type="checkbox" id="cv_vol" onchange="applyColVis()" checked> Today Vol / Wk / Mo / Qtr</label>
  </div>
  <div class="cvg">
    <div class="cvg-label">Momentum</div>
    <label class="cvc"><input type="checkbox" id="cv_score" onchange="applyColVis()" checked> Composite Score</label>
    <label class="cvc"><input type="checkbox" id="cv_momentum" onchange="applyColVis()" checked> 1M/3M/6M Returns, RS/Nifty, NR7</label>
  </div>
  <div style="padding:12px 16px;">
    <button class="btn" onclick="resetColVis()" style="width:100%;text-align:center">‚Ü∫ Reset to Default</button>
  </div>
</div>

<div id="alertPanel">
  <span id="alertLabel">‚ö† ALERTS</span>
  <div id="alertItems"></div>
  <button class="tbtn" onclick="dismissAlerts()" style="margin-left:auto;font-size:10px;padding:3px 8px">‚úï</button>
</div>

<div id="sbar">
  TOTAL <span class="sv" id="st">0</span>
  OK <span class="sv g" id="sok">0</span>
  ERR <span class="sv r" id="ser">0</span>
  <span id="prog" style="margin-left:auto"></span><button id="retryBtn" class="tbtn" style="display:none;font-size:10px;padding:3px 10px;margin-left:8px;border-color:var(--red);color:var(--red)" onclick="retryErrors()">‚Ü∫ Retry Errors</button>
</div>

<div id="twrap">
  <div id="empty">Add tickers or import CSV to get started</div>
  <div id="wlEmpty">No watchlist stocks yet ‚Äî click ‚òÜ on any row to add</div>
  <table id="tbl" style="display:none">
    <thead>
      <tr class="hg1">
        <th colspan="1"></th>
        <th colspan="1">SCORE</th>
        <th colspan="3" style="text-align:left">STOCK</th>
        <th colspan="3">SIGNAL</th>
        <th colspan="12">PRICE &amp; RANGE</th>
        <th colspan="4" class="sec-border">EMA VALUES &amp; SIGNALS</th>
        <th colspan="4" class="sec-border" id="hg1_emacond">EMA CONDITIONS (DAILY)</th>
        <th colspan="4" class="sec-border" id="hg1_wema">EMA CONDITIONS (WEEKLY)</th>
        <th colspan="4" class="sec-border">DAYS vs EMA</th>
        <th colspan="4" class="sec-border">VOLUME</th>
        <th colspan="6" class="sec-border">MOMENTUM</th>
      </tr>
      <tr class="hg2" id="colHeaders">
        <th class="wl-col-hd" style="cursor:default">WL</th>
        <th onclick="sortBy('score')" style="min-width:55px" title="Composite Momentum Score (0-100)">SCORE</th>
        <th style="text-align:left;min-width:100px" onclick="sortBy('sym')">TICKER</th>
        <th style="text-align:left;min-width:120px" onclick="sortBy('name')">NAME</th>
        <th style="text-align:left;min-width:100px" onclick="sortBy('industry')">INDUSTRY</th>
        <th onclick="sortBy('bull')">TREND</th>
        <th onclick="sortBy('phase')">PHASE</th>
        <th onclick="sortBy('coil')">COIL</th>
        <th onclick="sortBy('price')">PRICE ‚Çπ</th>
        <th onclick="sortBy('pch')">% DAY</th>
        <th onclick="sortBy('mcap')">MCAP CR</th>
        <th onclick="sortBy('pfh')" id="h_52wh">% 52W H</th>
        <th onclick="sortBy('pfl')" id="h_52wl">% 52W L</th>
        <th onclick="sortBy('pfath')" id="h_5yh">% 5Y H</th>
        <th onclick="sortBy('range5d')" id="h_rng5d">5D RNG%</th>
        <th onclick="sortBy('range4w')" id="h_rng4w">4W RNG%</th>
        <th onclick="sortBy('adr')" id="h_adr">ADR%</th>
        <th onclick="sortBy('awr')" id="h_awr">AWR%</th>
        <th onclick="sortBy('daysFrH')" id="h_pbh">DAYS fr 52H</th>
        <th onclick="sortBy('daysFrL')" id="h_pbl">DAYS fr 52L</th>
        <th class="sec-border" onclick="sortBy('e20')" id="h_e20">EMA 20</th>
        <th onclick="sortBy('e50')" id="h_e50">EMA 50</th>
        <th onclick="sortBy('e100')" id="h_e100">EMA 100</th>
        <th onclick="sortBy('e200')" id="h_e200">EMA 200</th>
        <th class="sec-border" onclick="sortBy('c_100gt200')" id="h_c1">100&gt;200</th>
        <th onclick="sortBy('c_50gt100')" id="h_c2">50&gt;100</th>
        <th onclick="sortBy('c_20gt50')" id="h_c3">20&gt;50</th>
        <th onclick="sortBy('c_pgt20')" id="h_c4">P&gt;20</th>
        <th class="sec-border" onclick="sortBy('wc_100gt200')" id="h_wc1">W:100&gt;200</th>
        <th onclick="sortBy('wc_50gt100')" id="h_wc2">W:50&gt;100</th>
        <th onclick="sortBy('wc_20gt50')" id="h_wc3">W:20&gt;50</th>
        <th onclick="sortBy('wc_pgt20')" id="h_wc4">W:P&gt;20</th>
        <th class="sec-border" onclick="sortBy('s20')" id="h_s20">vs EMA20</th>
        <th onclick="sortBy('s50')" id="h_s50">vs EMA50</th>
        <th onclick="sortBy('s100')" id="h_s100">vs EMA100</th>
        <th onclick="sortBy('s200')" id="h_s200">vs EMA200</th>
        <th class="sec-border" onclick="sortBy('todVol')" id="h_tvol">TODAY VOL</th>
        <th onclick="sortBy('wkAvg')" id="h_wvol">WK AVG</th>
        <th onclick="sortBy('moAvg')" id="h_mvol">MO AVG</th>
        <th onclick="sortBy('qtrAvgVol')" id="h_qvol">QTR AVG</th>
        <th class="sec-border" onclick="sortBy('ret1m')" id="h_r1m">1M RET%</th>
        <th onclick="sortBy('ret3m')" id="h_r3m">3M RET%</th>
        <th onclick="sortBy('ret6m')" id="h_r6m">6M RET%</th>
        <th onclick="sortBy('rsNifty')" id="h_rs">RS/NIFTY</th>
        <th onclick="sortBy('consec')" id="h_consec">CONSEC</th>
        <th onclick="sortBy('nr7')" id="h_nr7">NR7</th>
      </tr>
      <!-- FILTER ROW -->
      <tr class="hg3" id="filterRow">
        <th class="wl-col-hd"></th>
        <th><select class="fi-sel" id="f_score" onchange="applyFilters()">
          <option value="">Score: All</option>
          <option value="80">Elite ‚â•80</option>
          <option value="60">Strong ‚â•60</option>
          <option value="40">Active ‚â•40</option>
          <option value="20">Weak &lt;20</option>
        </select></th>
        <th><input class="fi" id="f_sym"  placeholder="ticker..." oninput="applyFilters()"></th>
        <th><input class="fi" id="f_name" placeholder="name..." oninput="applyFilters()"></th>
        <th><select class="fi-sel" id="f_industry" onchange="applyFilters()"><option value="">All Industries</option></select></th>
        <th><select class="fi-sel" id="f_bull" onchange="applyFilters()">
          <option value="">All Trend</option>
          <option value="1">&#9650; BULL</option>
          <option value="0">~ MIX</option>
          <option value="-1">&#9660; BEAR</option>
        </select></th>
        <th><select class="fi-sel" id="f_phase" onchange="applyFilters()">
          <option value="">All Phase</option>
          <option value="2">S2 UP</option>
          <option value="1">S1 BASE</option>
          <option value="3">S3 TOP</option>
          <option value="4">S4 DN</option>
        </select></th>
        <th><select class="fi-sel" id="f_coil" onchange="applyFilters()">
          <option value="">COIL: All</option>
          <option value="1">COIL Only</option>
          <option value="0">No Coil</option>
        </select></th>
        <th><select class="fi-sel" id="f_price" onchange="applyFilters()">
          <option value="">All Price</option>
          <option value="0-100">Under 100</option>
          <option value="100-500">100-500</option>
          <option value="500-1000">500-1K</option>
          <option value="1000-5000">1K-5K</option>
          <option value="5000-99999">Above 5K</option>
        </select></th>
        <th><select class="fi-sel" id="f_pch" onchange="applyFilters()">
          <option value="">All % Day</option>
          <option value="up2">Gainers &gt;+2%</option>
          <option value="up1">Gainers &gt;+1%</option>
          <option value="dn1">Losers &lt;-1%</option>
          <option value="dn2">Losers &lt;-2%</option>
          <option value="flat">Flat</option>
        </select></th>
        <th><select class="fi-sel" id="f_mcap" onchange="applyFilters()">
          <option value="">All Cap</option>
          <option value="large">Large &gt;20K Cr</option>
          <option value="mid">Mid 5-20K Cr</option>
          <option value="small">Small 500-5K</option>
          <option value="micro">Micro &lt;500 Cr</option>
        </select></th>
        <th><select class="fi-sel" id="f_pfh" onchange="applyFilters()">
          <option value="">52H: All</option>
          <option value="near">Near &gt;-5%</option>
          <option value="mid">-10% to -5%</option>
          <option value="down">-20% to -10%</option>
          <option value="deep">Deep &lt;-20%</option>
        </select></th>
        <th><select class="fi-sel" id="f_pfl" onchange="applyFilters()">
          <option value="">52L: All</option>
          <option value="near">Near &lt;+10%</option>
          <option value="mid">+10% to +30%</option>
          <option value="far">+30% to +80%</option>
          <option value="farther">&gt;+80%</option>
        </select></th>
        <th><span style="display:block;height:22px;background:rgba(255,255,255,.02);border-radius:3px;border:1px solid rgba(255,255,255,.04)"></span></th>
        <th><select class="fi-sel" id="f_range5d" onchange="applyFilters()">
          <option value="">5D: All</option>
          <option value="tight">Tight &lt;1%</option>
          <option value="coil">Coil &lt;2.5%</option>
          <option value="mid">2.5-5%</option>
          <option value="wide">Wide &gt;5%</option>
        </select></th>
        <th><select class="fi-sel" id="f_range4w" onchange="applyFilters()">
          <option value="">4W: All</option>
          <option value="tight">Tight &lt;5%</option>
          <option value="narrow">5-10%</option>
          <option value="mid">10-20%</option>
          <option value="wide">Wide &gt;20%</option>
        </select></th>
        <th><select class="fi-sel" id="f_adr" onchange="applyFilters()">
          <option value="">ADR: All</option>
          <option value="tight">Tight &lt;1%</option>
          <option value="mid">1-3%</option>
          <option value="wide">Wide &gt;3%</option>
        </select></th>
        <th><span style="display:block;height:22px;background:rgba(255,255,255,.02);border-radius:3px;border:1px solid rgba(255,255,255,.04)"></span></th>
        <th><select class="fi-sel" id="f_daysFrH" onchange="applyFilters()">
          <option value="">Days fr 52H: All</option>
          <option value="fresh">Fresh &lt;20d</option>
          <option value="mid">20-60d</option>
          <option value="old">Old &gt;60d</option>
        </select></th>
        <th><select class="fi-sel" id="f_daysFrL" onchange="applyFilters()">
          <option value="">Days fr 52L: All</option>
          <option value="fresh">Fresh &lt;20d</option>
          <option value="mid">20-60d</option>
          <option value="old">Old &gt;60d</option>
        </select></th>
        <th class="sec-border"><span style="display:block;height:22px;background:rgba(255,255,255,.02);border-radius:3px;border:1px solid rgba(255,255,255,.04)"></span></th>
        <th><span style="display:block;height:22px;background:rgba(255,255,255,.02);border-radius:3px;border:1px solid rgba(255,255,255,.04)"></span></th>
        <th><span style="display:block;height:22px;background:rgba(255,255,255,.02);border-radius:3px;border:1px solid rgba(255,255,255,.04)"></span></th>
        <th><span style="display:block;height:22px;background:rgba(255,255,255,.02);border-radius:3px;border:1px solid rgba(255,255,255,.04)"></span></th>
        <th class="sec-border"><select class="fi-sel" id="f_c100gt200" onchange="applyFilters()">
          <option value="">100&gt;200</option>
          <option value="1">YES</option>
          <option value="0">NO</option>
        </select></th>
        <th><select class="fi-sel" id="f_c50gt100" onchange="applyFilters()">
          <option value="">50&gt;100</option>
          <option value="1">YES</option>
          <option value="0">NO</option>
        </select></th>
        <th><select class="fi-sel" id="f_c20gt50" onchange="applyFilters()">
          <option value="">20&gt;50</option>
          <option value="1">YES</option>
          <option value="0">NO</option>
        </select></th>
        <th><select class="fi-sel" id="f_cpgt20" onchange="applyFilters()">
          <option value="">P&gt;20</option>
          <option value="1">YES</option>
          <option value="0">NO</option>
        </select></th>
        <th class="sec-border"><select class="fi-sel" id="f_wc100gt200" onchange="applyFilters()">
          <option value="">W:100&gt;200</option>
          <option value="1">YES</option>
          <option value="0">NO</option>
        </select></th>
        <th><select class="fi-sel" id="f_wc50gt100" onchange="applyFilters()">
          <option value="">W:50&gt;100</option>
          <option value="1">YES</option>
          <option value="0">NO</option>
        </select></th>
        <th><select class="fi-sel" id="f_wc20gt50" onchange="applyFilters()">
          <option value="">W:20&gt;50</option>
          <option value="1">YES</option>
          <option value="0">NO</option>
        </select></th>
        <th><select class="fi-sel" id="f_wcpgt20" onchange="applyFilters()">
          <option value="">W:P&gt;20</option>
          <option value="1">YES</option>
          <option value="0">NO</option>
        </select></th>
        <th class="sec-border"><span style="display:block;height:22px;background:rgba(255,255,255,.02);border-radius:3px;border:1px solid rgba(255,255,255,.04)"></span></th>
        <th><span style="display:block;height:22px;background:rgba(255,255,255,.02);border-radius:3px;border:1px solid rgba(255,255,255,.04)"></span></th>
        <th><span style="display:block;height:22px;background:rgba(255,255,255,.02);border-radius:3px;border:1px solid rgba(255,255,255,.04)"></span></th>
        <th><span style="display:block;height:22px;background:rgba(255,255,255,.02);border-radius:3px;border:1px solid rgba(255,255,255,.04)"></span></th>
        <th class="sec-border"><span style="display:block;height:22px;background:rgba(255,255,255,.02);border-radius:3px;border:1px solid rgba(255,255,255,.04)"></span></th>
        <th><span style="display:block;height:22px;background:rgba(255,255,255,.02);border-radius:3px;border:1px solid rgba(255,255,255,.04)"></span></th>
        <th><span style="display:block;height:22px;background:rgba(255,255,255,.02);border-radius:3px;border:1px solid rgba(255,255,255,.04)"></span></th>
        <th><select class="fi-sel" id="f_volratio_wk" onchange="applyFilters()">
          <option value="">Wk/Qtr: All</option>
          <option value="low">Below &lt;0.5x</option>
          <option value="1">Above &gt;1x</option>
          <option value="1.5">Active &gt;1.5x</option>
          <option value="2">Surge &gt;2x</option>
        </select></th>
        <th class="sec-border"><select class="fi-sel" id="f_ret3m" onchange="applyFilters()">
          <option value="">3M: All</option>
          <option value="20">Strong &gt;+20%</option>
          <option value="10">Good &gt;+10%</option>
          <option value="0">Positive</option>
          <option value="neg">Negative</option>
        </select></th>
        <th><span style="display:block;height:22px;background:rgba(255,255,255,.02);border-radius:3px;border:1px solid rgba(255,255,255,.04)"></span></th>
        <th><span style="display:block;height:22px;background:rgba(255,255,255,.02);border-radius:3px;border:1px solid rgba(255,255,255,.04)"></span></th>
        <th><select class="fi-sel" id="f_rs" onchange="applyFilters()">
          <option value="">RS: All</option>
          <option value="1.2">Leader &gt;1.2x</option>
          <option value="1">Outperform &gt;1x</option>
          <option value="under">Underperform &lt;1x</option>
        </select></th>
        <th><select class="fi-sel" id="f_nr7" onchange="applyFilters()">
          <option value="">NR7: All</option>
          <option value="1">NR7 Only</option>
        </select></th>
        <th><select class="fi-sel" id="f_vdu" onchange="applyFilters()">
          <option value="">Vol DU: All</option>
          <option value="1">Dry-Up Only</option>
        </select></th>
      </tr>
    </thead>
    <tbody id="tb"></tbody>
  </table>
</div>
<div id="paginationBar">
  <span class="pg-info" id="pgInfo"></span>
  <div class="pg-controls" id="pgControls"></div>
  <div style="display:flex;align-items:center;gap:6px;">
    <span style="font-size:11px;color:var(--mu2);">Per page:</span>
    <select class="pg-size" onchange="setPgSize(this.value)">
      <option value="50" selected>50</option>
      <option value="100">100</option>
      <option value="200">200</option>
      <option value="500">500</option>
    </select>
  </div>
</div>

<!-- FOOTER -->
<footer id="footer">
  <div class="footer-inner">
    <div class="footer-logo">STOCK<span style="-webkit-text-fill-color:inherit">PULSE</span>.IN</div>
    <div class="footer-tagline">NSE ¬∑ BSE Momentum Terminal &nbsp;|&nbsp; Real-time Data via Yahoo Finance</div>
    <div class="footer-links">
      <a href="#" onclick="document.getElementById('inp').scrollIntoView({behavior:'smooth'});return false">Add Stocks</a>
      <a href="#" onclick="document.getElementById('smartBar').scrollIntoView({behavior:'smooth'});return false">Smart Filters</a>
      <a href="#" onclick="exportCSV();return false">Export CSV</a>
      <a href="#" onclick="toggleColVis();return false">Column Settings</a>
      <a href="#" onclick="clearAllFilters();return false">Clear Filters</a>
    </div>
    <div class="footer-divider"></div>
    <div class="footer-copy">¬© 2025 StockPulse.in &nbsp;¬∑&nbsp; Data sourced from Yahoo Finance &nbsp;¬∑&nbsp; Refreshes every 60 minutes during market hours</div>
    <div class="footer-disclaimer">‚ö† For educational &amp; research purposes only. Not SEBI registered. Not investment advice. Past momentum is not a guarantee of future returns. Please consult a qualified financial advisor before making investment decisions.</div>
  </div>
</footer>

<div id="toast"></div>

<script>
var _todayDate=new Date().toDateString();
var DB_KEY='sp5db2',CACHE_KEY='sp5cache13',WL_KEY='sp5wl',SNAP_KEY='sp5snap',IND_KEY='sp5ind',CACHE_TTL=4*60*60*1000;
// Stock list loaded from /tickers.json ‚Äî edit that file in GitHub to update for all visitors
var DEFAULT_LIST=[];  // populated async from tickers.json

// PAGINATION state
var pgPage=1,pgSize=50;
var exch='NS';
var db=[],rows={},watchlist=new Set(),industries={};
var sortCol=null,sortDir=1,showWL=false,frozen=false;
var arTimer=null;

// ‚îÄ‚îÄ DB ‚îÄ‚îÄ
function load(){
  try{db=JSON.parse(localStorage.getItem(DB_KEY))||[];}catch(e){db=[];}
}
function seedDefaultList(list){
  // Called after tickers.json loads ‚Äî seed for visitors with empty DB
  if(db.length)return; // user has their own list
  var n=1;
  list.forEach(function(item){
    if(!has(item.sym)){
      db.push({n:n++,sym:item.sym,isDefault:true});
      industries[item.sym]={name:item.name||'',industry:item.industry||''};
    }
  });
}
function save(){localStorage.setItem(DB_KEY,JSON.stringify(db));}
function has(s){return db.some(function(t){return t.sym===s;});}
function nextN(){return db.length?Math.max.apply(null,db.map(function(t){return t.n;}))+1:1;}

// ‚îÄ‚îÄ INDUSTRIES ‚îÄ‚îÄ
function indLoad(){try{industries=JSON.parse(localStorage.getItem(IND_KEY))||{};}catch(e){industries={};}}
function indSave(){try{localStorage.setItem(IND_KEY,JSON.stringify(industries));}catch(e){}}
function getInd(sym){var r=industries[sym]||{};return{name:r.name||null,industry:r.industry||null};}

// ‚îÄ‚îÄ IMPORT CSV/EXCEL ‚îÄ‚îÄ
// Expected columns (case-insensitive, any order): Ticker, Name, Industry
// Exchange suffix auto-appended if missing
function importFile(input){
  var file=input.files[0];
  if(!file){return;}
  input.value='';
  var reader=new FileReader();
  if(file.name.match(/\.csv$/i)){
    reader.onload=function(e){parseImportCSV(e.target.result);};
    reader.readAsText(file);
  } else {
    // XLSX: read as binary then parse with manual zip/sheet extraction
    reader.onload=function(e){parseImportXLSX(e.target.result);};
    reader.readAsArrayBuffer(file);
  }
}
function parseImportCSV(text){
  var lines=text.split(/\r?\n/).filter(function(l){return l.trim();});
  if(!lines.length){toast('Empty file','er');return;}
  // Detect header row
  var hdr=lines[0].split(/,|\t/).map(function(h){return h.trim().toLowerCase().replace(/['"]/g,'');});
  var ti=hdr.findIndex(function(h){return h==='ticker'||h==='symbol'||h==='sym';});
  var ni=hdr.findIndex(function(h){return h==='name'||h==='company';});
  var ii=hdr.findIndex(function(h){return h==='industry'||h==='sector';});
  if(ti<0){toast('No Ticker column found','er');return;}
  var imported=0,added=0,n=nextN();
  for(var r=1;r<lines.length;r++){
    var cols=lines[r].split(/,|\t/).map(function(c){return c.trim().replace(/^["']|["']$/g,'');});
    if(!cols[ti])continue;
    var rawSym=cols[ti].trim().toUpperCase();
    var sym=rawSym.indexOf('.')>=0?rawSym:rawSym+'.'+exch;
    var name=ni>=0?cols[ni]||'':'';
    var industry=ii>=0?cols[ii]||'':'';
    industries[sym]={name:name,industry:industry};
    imported++;
    if(!has(sym)){db.push({n:n++,sym:sym});added++;}
  }
  indSave();save();renderDb();renderTbl();
  toast('Imported '+imported+' ‚Äî '+added+' new tickers added','ok');
  if(added>0){
    var newSyms=db.slice(-added).map(function(t){return t.sym;});
    go(newSyms);
  }
}
function parseImportXLSX(buf){
  // Manual XLSX parse ‚Äî extract first sheet rows as CSV then reuse CSV parser
  // XLSX is a zip file; we use a simple approach: search for shared strings and sheet data
  try{
    var uint8=new Uint8Array(buf);
    // Convert to string to find XML data (only works for xlsx with no compression, otherwise fallback)
    var str=new TextDecoder('utf-8',{fatal:false}).decode(uint8);
    // Try to extract CSV-like text by grabbing all <v> and <t> tags
    // Better approach: tell user to save as CSV
    toast('For Excel: please save as CSV first (File ‚Üí Save As ‚Üí CSV)','er');
  } catch(e){
    toast('Could not parse Excel. Save as CSV and try again','er');
  }
}

// ‚îÄ‚îÄ WATCHLIST ‚îÄ‚îÄ
function wlLoad(){try{var a=JSON.parse(localStorage.getItem(WL_KEY))||[];watchlist=new Set(a);}catch(e){watchlist=new Set();}}
function wlSave(){localStorage.setItem(WL_KEY,JSON.stringify([...watchlist]));}
function toggleStar(sym){watchlist.has(sym)?watchlist.delete(sym):watchlist.add(sym);wlSave();renderTbl();updateWLCount();}
function updateWLCount(){document.getElementById('wlCount').textContent=watchlist.size?'('+watchlist.size+')':'';}
function toggleWL(){
  showWL=!showWL;
  var b=document.getElementById('wlToggle');
  b.className='tbtn'+(showWL?' on':'');
  b.innerHTML=(showWL?'‚òÖ':'‚òÜ')+' Watchlist <span id="wlCount"></span>';
  document.getElementById('searchBox').value='';
  updateWLCount();renderTbl();
}

// ‚îÄ‚îÄ FREEZE ‚îÄ‚îÄ
function toggleFreeze(){
  frozen=!frozen;
  document.getElementById('tbl').className=frozen?'frz':'';
  var b=document.getElementById('freezeBtn');
  b.className='tbtn'+(frozen?' on':'');
  b.textContent=frozen?'üîì Unfreeze':'‚ùÑ Freeze Cols';
  toast(frozen?'Columns frozen':'Columns unfrozen','ok');
}

// ‚îÄ‚îÄ AUTO REFRESH ‚îÄ‚îÄ
function setAutoRefresh(){
  clearInterval(arTimer);arTimer=null;
  document.getElementById('arInfo').textContent='';
  var mins=parseInt(document.getElementById('arSel').value)||0;
  if(!mins)return;
  startARTimer(mins);
}
function startARTimer(mins){
  document.getElementById('arInfo').textContent='‚Üª '+mins+'min';
  arTimer=setInterval(function(){
    if(!db.length)return;
    var syms=db.map(function(t){return t.sym;});
    var c=JSON.parse(localStorage.getItem(CACHE_KEY)||'{}');
    syms.forEach(function(s){delete c[s];});
    localStorage.setItem(CACHE_KEY,JSON.stringify(c));
    go(syms);
  },mins*60*1000);
}

// ‚îÄ‚îÄ CACHE ‚îÄ‚îÄ
function cacheLoad(){try{return JSON.parse(localStorage.getItem(CACHE_KEY))||{};}catch(e){return{};}}
function cacheSave(c){try{localStorage.setItem(CACHE_KEY,JSON.stringify(c));}catch(e){}}
function cacheGet(sym){var c=cacheLoad(),e=c[sym];if(!e||Date.now()-e.ts>CACHE_TTL)return null;return e.data;}
function cacheSet(sym,data){data._fetchedDate=_todayDate;var c=cacheLoad();c[sym]={ts:Date.now(),data:data};cacheSave(c);}
function cacheClear(){localStorage.removeItem(CACHE_KEY);toast('Cache cleared','ok');updateCacheNote();}
function updateCacheNote(){
  var c=cacheLoad(),fresh=Object.keys(c).filter(function(k){return Date.now()-c[k].ts<CACHE_TTL;}).length;
  document.getElementById('cacheNote').innerHTML=fresh
    ?'Cache: '+fresh+' stocks (4hr) &nbsp;<a href="#" onclick="cacheClear();return false;">clear</a>':'';
}

// ‚îÄ‚îÄ ALERT SNAPSHOT ‚îÄ‚îÄ
function getSnap(){try{return JSON.parse(localStorage.getItem(SNAP_KEY))||{};}catch(e){return{};}}
function setSnap(s){try{localStorage.setItem(SNAP_KEY,JSON.stringify(s));}catch(e){}}
function checkAlerts(){
  var prev=getSnap(),newSnap={},alerts=[];
  db.forEach(function(t){
    var d=rows[t.sym];
    if(!d||!d.price||d.err||d.loading)return;
    var sym=t.sym,s=sym.replace(/\.(NS|BO)$/,'');
    newSnap[sym]={bull:d.bull,phase:d.phase,bo52h:d.bo52h,bo52l:d.bo52l,volSpike:d.volSpike,coil:d.coil,cross200:d.cross200};
    var p=prev[sym];if(!p)return;
    if(p.bull!==d.bull&&d.bull!==null&&p.bull!==null){
      if(d.bull===1)alerts.push({type:'bull',msg:s+' ‚Üí ‚ñ≤ BULL'});
      else if(d.bull===-1)alerts.push({type:'bear',msg:s+' ‚Üí ‚ñº BEAR'});
      else alerts.push({type:'phase',msg:s+' ‚Üí ~ MIX'});
    }
    if(p.phase!==d.phase&&d.phase!==null&&p.phase!==null){
      var dir=d.phase<p.phase?'‚Üë':'‚Üì';
      alerts.push({type:'phase',msg:s+' Phase '+dir+' S'+d.phase});
    }
    if(!p.bo52h&&d.bo52h)alerts.push({type:'brk',msg:s+' üî• 52W HIGH BO'});
    if(!p.bo52l&&d.bo52l)alerts.push({type:'bear',msg:s+' ‚ö† 52W LOW BRK'});
    if(!p.volSpike&&d.volSpike)alerts.push({type:'vol',msg:s+' ‚ö° VOL 2x SPIKE'});
    if(!p.coil&&d.coil)alerts.push({type:'coil',msg:s+' üåÄ COIL'});
    if(!p.cross200&&d.cross200==='up')alerts.push({type:'cross',msg:s+' ‚Üë Crossed 200 EMA'});
    if(!p.cross200&&d.cross200==='dn')alerts.push({type:'bear',msg:s+' ‚Üì Broke 200 EMA'});
  });
  setSnap(newSnap);
  return alerts;
}
function showAlerts(alerts){
  var panel=document.getElementById('alertPanel');
  if(!alerts.length){panel.className='';return;}
  var clsMap={bull:'al-bull',bear:'al-bear',brk:'al-brk',vol:'al-vol',phase:'al-phase',coil:'al-coil',cross:'al-cross'};
  var h='';
  alerts.forEach(function(a){h+='<span class="al '+(clsMap[a.type]||'')+'">'+esc(a.msg)+'</span>';});
  document.getElementById('alertItems').innerHTML=h;
  panel.className='on';
}
function dismissAlerts(){document.getElementById('alertPanel').className='';}

// ‚îÄ‚îÄ EXCHANGE ‚îÄ‚îÄ
function setX(e){
  exch=e;
  document.getElementById('bns').className='eb'+(e==='NS'?' on':'');
  document.getElementById('bbo').className='eb'+(e==='BO'?' on':'');
}

// ‚îÄ‚îÄ PARSE ‚îÄ‚îÄ
function parseSyms(raw){
  return raw.split(/[\n,;\s]+/).map(function(s){
    s=s.trim().toUpperCase();if(!s)return null;
    return s.indexOf('.')>=0?s:s+'.'+exch;
  }).filter(Boolean);
}

// ‚îÄ‚îÄ DB BAR ‚îÄ‚îÄ
function renderDb(){
  var n=db.length;
  document.getElementById('dbCount').textContent=n;
  document.getElementById('rbtn').disabled=!n;
  var errCount=db.filter(function(t){return rows[t.sym]&&rows[t.sym].err;}).length;
  var badge=document.getElementById('errBadge');
  if(errCount>0){badge.textContent=errCount+' INVALID';badge.style.display='';}
  else{badge.style.display='none';}
}
function del(sym){
  db=db.filter(function(t){return t.sym!==sym;});
  watchlist.delete(sym);wlSave();save();delete rows[sym];
  renderDb();renderTbl();updateWLCount();
  if(document.getElementById('modal').classList.contains('on'))renderModal();
}
function clearAllDB(){
  if(!db.length)return;
  if(!confirm('Remove all '+db.length+' stocks from DB?'))return;
  db=[];rows={};watchlist=new Set();
  save();wlSave();renderDb();renderTbl();updateWLCount();updateStats();
  document.getElementById('sbar').className='';
  toast('All stocks cleared','ok');
}
function removeInvalid(){
  var invalid=db.filter(function(t){return rows[t.sym]&&rows[t.sym].err;});
  if(!invalid.length){toast('No invalid stocks found','');return;}
  invalid.forEach(function(t){db=db.filter(function(x){return x.sym!==t.sym;});delete rows[t.sym];});
  save();renderDb();renderTbl();renderModal();
  toast(invalid.length+' invalid tickers removed','ok');
}

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
function openModal(){renderModal();document.getElementById('modal').className='on';}
function closeModal(){document.getElementById('modal').className='';}
function renderModal(){
  var errCount=db.filter(function(t){return rows[t.sym]&&rows[t.sym].err;}).length;
  var okCount=db.filter(function(t){return rows[t.sym]&&rows[t.sym].price;}).length;
  var loadCount=db.filter(function(t){return rows[t.sym]&&rows[t.sym].loading;}).length;
  var newCount=db.filter(function(t){return !rows[t.sym];}).length;
  document.getElementById('modalStats').textContent=
    db.length+' stocks  ‚úì '+okCount+'  ‚úó '+errCount+(loadCount?' ‚ü≥ '+loadCount:'')+(newCount?' ‚óè '+newCount+' pending':'');
  document.getElementById('rmInvalidBtn').style.display=errCount>0?'':'none';
  var h='';
  db.forEach(function(t){
    var sym=t.sym,s=sym.replace(/\.(NS|BO)$/,''),xt=sym.endsWith('.BO')?'.BO':'.NS';
    var meta=getInd(sym),r=rows[sym];
    var statusHtml,invalid=false;
    if(!r){statusHtml='<span class="ms-new">not fetched</span>';}
    else if(r.loading){statusHtml='<span class="ms-load">‚ü≥ fetching</span>';}
    else if(r.err){statusHtml='<span class="ms-err">‚úó '+esc(r.err.substring(0,22))+'</span>';invalid=true;}
    else{statusHtml='<span class="ms-ok">‚úì '+(r.price?'‚Çπ'+r.price.toFixed(0):'OK')+'</span>';}
    h+='<div class="mrow" style="'+(invalid?'background:rgba(255,68,102,.04);':'')+'">'
      +'<span class="mrow-num">#'+t.n+'</span>'
      +'<span class="mrow-sym">'+s+'<span style="font-size:9px;color:var(--mu);margin-left:2px">'+xt+'</span></span>'
      +'<span class="mrow-name">'+esc((r&&r.name)||meta.name||'')+'</span>'
      +'<span class="mrow-ind">'+esc(meta.industry||'')+'</span>'
      +'<span class="mrow-status">'+statusHtml+'</span>'
      +'<button class="mrow-del" onclick="del(\x27'+sym+'\x27)">‚úï</button>'
      +'</div>';
  });
  if(!db.length)h='<div style="padding:40px;text-align:center;color:var(--mu)">No stocks in DB.</div>';
  document.getElementById('modalBody').innerHTML=h;
}

// ‚îÄ‚îÄ EMA ‚îÄ‚îÄ
function calcEMAArr(closes,period){
  if(!closes||closes.length<period)return null;
  var k=2/(period+1),ema=0,arr=[],i;
  for(i=0;i<period;i++)ema+=closes[i];
  ema/=period;arr.push(ema);
  for(i=period;i<closes.length;i++){ema=closes[i]*k+ema*(1-k);arr.push(ema);}
  return arr;
}

// FIXED: streak counts consecutive days where CLOSING PRICE is above (positive) or below (negative) EMA
// offset aligns closes with emaArr (emaArr starts at index `period` of closes)
function streakVsEMA(closes,emaArr){
  if(!closes||!emaArr||!emaArr.length)return 0;
  var offset=closes.length-emaArr.length;  // how many initial closes were used for warmup
  var n=emaArr.length;
  var lastAbove=closes[closes.length-1]>=emaArr[n-1];
  var count=0;
  for(var i=n-1;i>=0;i--){
    var closeAbove=closes[offset+i]>=emaArr[i];
    if(closeAbove===lastAbove)count++;
    else break;
  }
  return lastAbove?count:-count;
}

// ‚îÄ‚îÄ BULL / PHASE ‚îÄ‚îÄ
function getBull(p,e20,e50,e100,e200){
  if(p==null||e20==null||e50==null||e100==null||e200==null)return null;
  if(p>e20&&e20>e50&&e50>e100&&e100>e200)return 1;
  if(p<e20&&e20<e50&&e50<e100&&e100<e200)return -1;
  return 0;
}
function getPhase(p,e20,e50,e100,e200){
  if(p==null||e200==null)return null;
  var a200=p>e200,a50=e50!=null&&p>e50,a20=e20!=null&&p>e20;
  if(a200&&a50&&a20)return 2;
  if(!a200&&!a50&&!a20)return 4;
  if(a200&&!a20)return 3;
  return 1;
}

// ‚îÄ‚îÄ PROXY ‚Äî tries Netlify fn ‚Üí corsproxy.io ‚Üí allorigins in sequence ‚îÄ‚îÄ
function proxyUrl(sym,range,interval){
  interval=interval||'1d';
  return '/.netlify/functions/quote?sym='+encodeURIComponent(sym)+'&range='+(range||'3y')+'&interval='+interval;
}
function yahooUrl(sym,range,interval){
  return 'https://query2.finance.yahoo.com/v8/finance/chart/'
    +encodeURIComponent(sym)+'?interval='+interval+'&range='+range+'&includePrePost=false&corsDomain=finance.yahoo.com';
}
var _proxyFails=0; // track netlify fn failures to skip if consistently broken
// AbortController timeout ‚Äî works on ALL mobile browsers
function fetchWithTimeout(url,ms){
  var ctrl=new AbortController();
  var tid=setTimeout(function(){ctrl.abort();},ms||40000);
  return fetch(url,{signal:ctrl.signal})
    .then(function(r){clearTimeout(tid);return r;})
    .catch(function(e){clearTimeout(tid);throw e;});
}
function buildProxies(sym,range,interval){
  var yUrl=yahooUrl(sym,range,interval);
  var list=[];
  if(_proxyFails<8)list.push({url:proxyUrl(sym,range,interval),nl:true});
  list.push({url:'https://thingproxy.freeboard.io/fetch/'+yUrl,nl:false});
  list.push({url:'https://corsproxy.io/?'+encodeURIComponent(yUrl),nl:false});
  list.push({url:'https://api.allorigins.win/raw?url='+encodeURIComponent(yUrl),nl:false});
  list.push({url:'https://proxy.cors.sh/'+yUrl,nl:false});
  return list;
}
function proxyFetch(sym,range,interval){
  interval=interval||'1d';range=range||'3y';
  var proxies=buildProxies(sym,range,interval);
  function tryNext(i){
    if(i>=proxies.length)return Promise.reject(new Error('All proxies failed'));
    var p=proxies[i];
    return fetchWithTimeout(p.url,40000)
      .then(function(r){if(r.ok)return r;if(p.nl)_proxyFails++;return tryNext(i+1);})
      .catch(function(){if(p.nl)_proxyFails++;return tryNext(i+1);});
  }
  return tryNext(0);
}
function fetchATH(sym){
  return proxyFetch(sym,'5y','1mo')
    .then(function(r){if(!r.ok)return null;return r.json();})
    .then(function(j){
      if(!j)return null;
      var res=j.chart&&j.chart.result&&j.chart.result[0];if(!res)return null;
      var q=(res.indicators&&res.indicators.quote&&res.indicators.quote[0])||{};
      var highs=(q.high||[]).filter(function(v){return v!=null;});
      return highs.length?Math.max.apply(null,highs):null;
    })
    .catch(function(){return null;});
}

// ‚îÄ‚îÄ MAIN FETCH ‚Äî 3yr daily data (more warmup for EMA200 weekly EMA accuracy) ‚îÄ‚îÄ
function fetchMain(sym){
  return proxyFetch(sym,'3y','1d')
    .then(function(r){if(!r.ok)throw new Error('HTTP '+r.status);return r.json();})
    .then(function(j){
      if(j.chart&&j.chart.error)throw new Error(j.chart.error.description||'Yahoo error');
      var res=j.chart&&j.chart.result&&j.chart.result[0];
      if(!res)throw new Error('No data');
      var m=res.meta||{};
      var q=(res.indicators&&res.indicators.quote&&res.indicators.quote[0])||{};
      var rawC=q.close||[],rawV=q.volume||[],rawH=q.high||[],rawL=q.low||[],closes=[],highs=[],lows=[],vols=[],lc=null,lh=null,ll=null,i;
      for(i=0;i<rawC.length;i++){
        if(rawC[i]!=null){lc=rawC[i];closes.push(lc);}else if(lc!=null)closes.push(lc);
        if(rawH[i]!=null){lh=rawH[i];highs.push(lh);}else if(lh!=null)highs.push(lh);
        if(rawL[i]!=null){ll=rawL[i];lows.push(ll);}else if(ll!=null)lows.push(ll);
        vols.push(rawV[i]!=null?rawV[i]:0);
      }
      var price=m.regularMarketPrice||(closes.length?closes[closes.length-1]:null);
      if(!price)throw new Error('No price');
      var prev=closes.length>=2?closes[closes.length-2]:null;

      // EMAs on full 2yr array ‚Äî more warmup = more accurate streaks
      var e20a=calcEMAArr(closes,20),e50a=calcEMAArr(closes,50);
      var e100a=calcEMAArr(closes,100),e200a=calcEMAArr(closes,200);
      function lv(a){return a&&a.length?a[a.length-1]:null;}
      var e20=lv(e20a),e50=lv(e50a),e100=lv(e100a),e200=lv(e200a);

      // 52W H/L from last 252 CLOSES ‚Äî track index simultaneously for days-from calc
      var last252=closes.slice(-252);
      var hi52=-Infinity,lo52=Infinity,hiIdx52=0,loIdx52=0;
      for(var k52=0;k52<last252.length;k52++){
        if(last252[k52]>hi52){hi52=last252[k52];hiIdx52=k52;}
        if(last252[k52]<lo52){lo52=last252[k52];loIdx52=k52;}
      }
      if(!last252.length){hi52=null;lo52=null;}
      // daysFrH/L = trading days since the close 52W high/low occurred
      var daysFrH=last252.length?last252.length-1-hiIdx52:null;
      var daysFrL=last252.length?last252.length-1-loIdx52:null;
      // Also fold in Yahoo meta fields for % calc (intraday extreme may differ from close)
      if(m.fiftyTwoWeekHigh&&hi52)hi52=Math.max(hi52,m.fiftyTwoWeekHigh);
      else if(m.fiftyTwoWeekHigh)hi52=m.fiftyTwoWeekHigh;
      if(m.fiftyTwoWeekLow&&lo52)lo52=Math.min(lo52,m.fiftyTwoWeekLow);
      else if(m.fiftyTwoWeekLow)lo52=m.fiftyTwoWeekLow;

      // 200 EMA cross detection: check if YESTERDAY's close was on opposite side of EMA200
      // prev < prevEMA200 and price >= e200 ‚Üí crossed above (bullish)
      // prev > prevEMA200 and price <= e200 ‚Üí crossed below (bearish)
      var cross200=null;
      if(e200a&&e200a.length>=2&&prev!=null&&e200!=null){
        var prevE200=e200a[e200a.length-2];
        if(prev<prevE200&&price>=e200)cross200='up';
        else if(prev>prevE200&&price<=e200)cross200='dn';
      }

      // 5d range / COIL
      var last5=closes.slice(-5);
      var range5d=last5.length>=5?(Math.max.apply(null,last5)-Math.min.apply(null,last5))/price*100:null;
      var coil=range5d!=null&&range5d<2.5;

      // 4-week range (20 trading days)
      var last20=closes.slice(-20);
      var range4w=last20.length>=10
        ?(Math.max.apply(null,last20)-Math.min.apply(null,last20))/price*100
        :null;

      // Volume
      var cleanV=vols.filter(function(v){return v>0;});
      var todVol=cleanV.length?cleanV[cleanV.length-1]:null;
      var wkSlice=cleanV.slice(-6,-1);
      var moSlice=cleanV.slice(-22,-1);
      var qtrSlice=cleanV.slice(-63,-1); // ~63 trading days = 1 quarter
      var wkAvg=wkSlice.length?wkSlice.reduce(function(a,b){return a+b;},0)/wkSlice.length:null;
      var moAvg=moSlice.length?moSlice.reduce(function(a,b){return a+b;},0)/moSlice.length:null;
      var qtrAvgVol=qtrSlice.length>=20?qtrSlice.reduce(function(a,b){return a+b;},0)/qtrSlice.length:null;
      var volSpike=!!(todVol&&moAvg&&todVol>2*moAvg);
      // Vol ratio vs quarterly avg ‚Äî week avg / qtr avg
      var volRatio=(wkAvg&&qtrAvgVol&&qtrAvgVol>0)?wkAvg/qtrAvgVol:null;

      // ‚îÄ‚îÄ ADR: Average Daily Range (14d) ‚Äî (high-low)/close * 100 ‚îÄ‚îÄ
      var adrSlice14=[];
      for(var ai=Math.max(0,highs.length-14);ai<highs.length;ai++){
        if(highs[ai]!=null&&lows[ai]!=null&&closes[ai]&&closes[ai]>0)
          adrSlice14.push((highs[ai]-lows[ai])/closes[ai]*100);
      }
      var adr=adrSlice14.length?adrSlice14.reduce(function(a,b){return a+b;},0)/adrSlice14.length:null;

      // ‚îÄ‚îÄ AWR: Average Weekly Range (10 weeks = 50 days, sample weekly bars) ‚îÄ‚îÄ
      // Build weekly OHLC by grouping every 5 daily bars
      var weeklyH=[],weeklyL=[],weeklyC=[];
      for(var wi=0;wi<closes.length-4;wi+=5){
        var wH=Math.max.apply(null,highs.slice(wi,wi+5).filter(function(x){return x!=null;}));
        var wL=Math.min.apply(null,lows.slice(wi,wi+5).filter(function(x){return x!=null;}));
        var wC=closes[wi+4]||closes[wi+3]||closes[wi+2];
        if(wH&&wL&&wC){weeklyH.push(wH);weeklyL.push(wL);weeklyC.push(wC);}
      }
      var awrSlice=[];
      for(var awi=Math.max(0,weeklyH.length-10);awi<weeklyH.length;awi++){
        if(weeklyC[awi]>0)awrSlice.push((weeklyH[awi]-weeklyL[awi])/weeklyC[awi]*100);
      }
      var awr=awrSlice.length?awrSlice.reduce(function(a,b){return a+b;},0)/awrSlice.length:null;

      // ‚îÄ‚îÄ WEEKLY EMAs (from weekly closes) ‚îÄ‚îÄ
      var we20a=calcEMAArr(weeklyC,20),we50a=calcEMAArr(weeklyC,50);
      var we100a=calcEMAArr(weeklyC,100),we200a=calcEMAArr(weeklyC,200);
      var we20=lv(we20a),we50=lv(we50a),we100=lv(we100a),we200=lv(we200a);
      var wPrice=weeklyC.length?weeklyC[weeklyC.length-1]:price;
      var wc_100gt200=(we100!=null&&we200!=null)?we100>we200:null;
      var wc_50gt100=(we50!=null&&we100!=null)?we50>we100:null;
      var wc_20gt50=(we20!=null&&we50!=null)?we20>we50:null;
      var wc_pgt20=(wPrice!=null&&we20!=null)?wPrice>we20:null;

      // daysFrH/L computed above during 52W H/L scan

      // EMA cross signals (today vs yesterday) ‚Äî detect price crossing any EMA today
      // cross = price was below EMA yesterday, above today (or vice versa)
      var emaCrossSignals=[];
      function chkCross(label,emaArr){
        if(!emaArr||emaArr.length<2||closes.length<2)return;
        var n=emaArr.length;
        var off=closes.length-n;
        var curClose=closes[closes.length-1];
        var prevClose=closes[closes.length-2];
        var curEMA=emaArr[n-1];
        var prevEMA=emaArr[n-2];
        if(prevClose<prevEMA&&curClose>=curEMA)emaCrossSignals.push({ema:label,dir:'up'});
        else if(prevClose>prevEMA&&curClose<=curEMA)emaCrossSignals.push({ema:label,dir:'dn'});
      }
      chkCross('EMA20',e20a);
      chkCross('EMA50',e50a);
      chkCross('EMA100',e100a);
      chkCross('EMA200',e200a);

      var c_100gt200=(e100!=null&&e200!=null)?e100>e200:null;
      var c_50gt100=(e50!=null&&e100!=null)?e50>e100:null;
      var c_20gt50=(e20!=null&&e50!=null)?e20>e50:null;
      var c_pgt20=(price!=null&&e20!=null)?price>e20:null;

      // ‚îÄ‚îÄ 1M / 3M / 6M RETURNS (using close N bars ago) ‚îÄ‚îÄ
      function retPct(barsAgo){
        var old=closes[closes.length-1-barsAgo];
        return(old&&old>0)?(price-old)/old*100:null;
      }
      var ret1m=retPct(21),ret3m=retPct(63),ret6m=retPct(126);

      // ‚îÄ‚îÄ NR7: today's range is narrowest of last 7 days ‚îÄ‚îÄ
      var nr7=false;
      if(highs.length>=7&&lows.length>=7){
        var todRange=highs[highs.length-1]-lows[lows.length-1];
        var nr7ok=true;
        for(var nri=2;nri<=7;nri++){
          var pr=highs[highs.length-nri]-lows[lows.length-nri];
          if(pr<=todRange){nr7ok=false;break;}
        }
        nr7=nr7ok&&todRange>0;
      }

      // ‚îÄ‚îÄ CONSECUTIVE UP/DOWN CLOSE DAYS ‚îÄ‚îÄ
      var consec=0;
      if(closes.length>=2){
        var up0=closes[closes.length-1]>closes[closes.length-2];
        for(var ci=closes.length-1;ci>0;ci--){
          var upI=closes[ci]>closes[ci-1];
          if(upI===up0)consec+=(up0?1:-1);
          else break;
        }
      }

      // ‚îÄ‚îÄ VOLUME DRY-UP: last 5d avg < 50% of 20d avg ‚îÄ‚îÄ
      var volDryUp=!!(wkAvg&&moAvg&&wkAvg<moAvg*0.5);

      // ‚îÄ‚îÄ COMPOSITE MOMENTUM SCORE (0-100) ‚îÄ‚îÄ
      // Each condition adds points, sort descending = best setups first
      var score=0;
      var bull_val=getBull(price,e20,e50,e100,e200);
      var phase_val=getPhase(price,e20,e50,e100,e200);
      if(bull_val===1)score+=20;                                  // Full BULL alignment
      if(phase_val===2)score+=20;                                 // Stage 2 uptrend
      if(c_pgt20)score+=10;                                       // Price > EMA20
      if(c_100gt200)score+=10;                                    // 100 > 200
      if(c_50gt100)score+=10;                                     // 50 > 100
      if(todVol&&moAvg&&todVol>moAvg)score+=10;                  // Today vol > monthly avg
      if(hi52&&price&&price>=hi52*0.95)score+=10;                // Within 5% of 52W high
      if(wc_100gt200)score+=5;                                   // Weekly 100 > 200
      if(wc_pgt20)score+=5;                                      // Weekly price > EMA20

      return{
        sym:sym,err:null,
        name:m.shortName||m.longName||sym,
        price:price,prev:prev,
        pch:prev?(price-prev)/prev*100:null,
        hi52:hi52,lo52:lo52,
        pfh:price&&hi52?(price-hi52)/hi52*100:null,
        pfl:price&&lo52?(price-lo52)/lo52*100:null,
        bo52h:!!(price&&hi52&&price>=hi52*0.999),
        bo52l:!!(price&&lo52&&price<=lo52*1.001),
        mcap:m.marketCap?m.marketCap/1e7:null,
        e20:e20,e50:e50,e100:e100,e200:e200,
        c_100gt200:c_100gt200,c_50gt100:c_50gt100,c_20gt50:c_20gt50,c_pgt20:c_pgt20,
        s20:e20a?streakVsEMA(closes,e20a):0,
        s50:e50a?streakVsEMA(closes,e50a):0,
        s100:e100a?streakVsEMA(closes,e100a):0,
        s200:e200a?streakVsEMA(closes,e200a):0,
        bull:getBull(price,e20,e50,e100,e200),
        phase:getPhase(price,e20,e50,e100,e200),
        todVol:todVol,wkAvg:wkAvg,moAvg:moAvg,
        volSpike:volSpike,range5d:range5d,coil:coil,
        range4w:range4w,
        qtrAvgVol:qtrAvgVol,volRatio:volRatio,
        emaCrossSignals:emaCrossSignals,
        cross200:cross200,
        adr:adr,awr:awr,
        daysFrH:daysFrH,daysFrL:daysFrL,
        wc_100gt200:wc_100gt200,wc_50gt100:wc_50gt100,wc_20gt50:wc_20gt50,wc_pgt20:wc_pgt20,
        ret1m:ret1m,ret3m:ret3m,ret6m:ret6m,
        nr7:nr7,consec:consec,volDryUp:volDryUp,score:score,
        rsNifty:null,
        ath:null,pfath:null
      };
    });
}

// ‚îÄ‚îÄ NIFTY RS ‚Äî fetch ^NSEI once per session, compute 3M return ‚îÄ‚îÄ
var niftyRet3m=null,niftyFetched=false,niftyFetching=false;
function fetchNifty(){
  if(niftyFetched||niftyFetching)return Promise.resolve(niftyRet3m);
  niftyFetching=true;
  return proxyFetch('%5ENSEI','3y','1d')
    .then(function(r){return r.json();})
    .then(function(j){
      var res=j.chart&&j.chart.result&&j.chart.result[0];
      if(!res)return null;
      var q=(res.indicators&&res.indicators.quote&&res.indicators.quote[0])||{};
      var nc=[];var rawNC=q.close||[];
      for(var i=0;i<rawNC.length;i++){if(rawNC[i]!=null)nc.push(rawNC[i]);}
      if(nc.length<64)return null;
      var last=nc[nc.length-1];
      var ago63=nc[nc.length-64];
      niftyRet3m=(last&&ago63&&ago63>0)?(last-ago63)/ago63*100:null;
      niftyFetched=true;
      return niftyRet3m;
    })
    .catch(function(){niftyFetched=true;return null;});
}

// ‚îÄ‚îÄ FETCH ONE (main + ATH + Nifty parallel) ‚îÄ‚îÄ
function fetchOne(sym){
  return Promise.all([fetchMain(sym),fetchATH(sym),fetchNifty()])
    .then(function(res){
      var d=res[0];
      d.ath=res[1];
      d.pfath=d.price&&d.ath?(d.price-d.ath)/d.ath*100:null;
      // RS vs Nifty: stock 3M return / Nifty 3M return
      if(d.ret3m!=null&&niftyRet3m!=null&&niftyRet3m!==0){
        d.rsNifty=d.ret3m/niftyRet3m;
      }
      cacheSet(sym,d);return d;
    });
}

// ‚îÄ‚îÄ ADD & FETCH ‚îÄ‚îÄ
function addFetch(){
  var raw=document.getElementById('ti').value.trim();
  if(!raw){toast('Type tickers first','er');return;}
  var syms=parseSyms(raw);if(!syms.length){toast('No valid tickers','er');return;}
  var added=[],n=nextN();
  syms.forEach(function(s){if(!has(s)){db.push({n:n++,sym:s});added.push(s);}});
  save();document.getElementById('ti').value='';renderDb();
  if(!added.length){toast('All already in DB','');return;}
  toast(added.length+' added ‚Äî fetching...','ok');go(added);
}
function refreshAll(){if(!db.length)return;go(db.map(function(t){return t.sym;}));}

// ‚îÄ‚îÄ FETCH LOOP ‚Äî batched to avoid Yahoo rate limits ‚îÄ‚îÄ
// Batch size 8, 400ms between batches ‚Üí ~1000 stocks ‚âà 50 batches ‚âà 20s total
var BATCH_SIZE=4, BATCH_DELAY=800;
function go(syms){
  document.getElementById('sbar').className='on';
  var toFetch=[],done=0,total=0;
  syms.forEach(function(s){
    var cached=cacheGet(s);
    if(cached)rows[s]=cached;else{toFetch.push(s);rows[s]={sym:s,loading:true};}
  });
  total=toFetch.length;
  renderTbl();updateStats();
  if(!total){
    var _cn=new Date();
    document.getElementById('lastUpd').innerHTML=
      '<span style="color:var(--mu);font-size:9px;margin-right:4px">‚óè</span>Cache: '
      +_cn.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'})
      +' <span style="color:var(--acc);font-weight:600">'
      +_cn.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true})+'</span>';
    toast('All '+syms.length+' from cache','ok');updateCacheNote();return;
  }
  setP(0,total);
  // Split into batches and run with delay
  var batches=[];
  for(var i=0;i<toFetch.length;i+=BATCH_SIZE)batches.push(toFetch.slice(i,i+BATCH_SIZE));
  function runBatch(bi){
    if(bi>=batches.length)return;
    var batch=batches[bi];
    var promises=batch.map(function(sym){
      return fetchOne(sym)
        .then(function(d){rows[sym]=d;})
        .catch(function(e){
          // retry once on network failure (mobile blip)
          if(e.message&&(e.message.indexOf('fetch')>=0||e.message.indexOf('abort')>=0||e.message.indexOf('network')>=0)){
            return fetchOne(sym)
              .then(function(d){rows[sym]=d;})
              .catch(function(e2){rows[sym]={sym:sym,err:e2.message||'Failed'};});
          }
          rows[sym]={sym:sym,err:e.message||'Failed'};
        })
        .finally(function(){
          done++;setP(done,total);updateStats();renderTbl();
          if(done===total){
            var _now=new Date();
            document.getElementById('lastUpd').innerHTML=
              '<span style="color:var(--green);font-size:9px;margin-right:4px">‚óè</span>Updated: '
              +_now.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'})
              +' <span style="color:var(--acc);font-weight:600">'
              +_now.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true})+'</span>';
            toast('Done ‚Äî '+total+' fetched','ok');updateCacheNote();
            showAlerts(checkAlerts());
          }
        });
    });
    Promise.all(promises).then(function(){
      setTimeout(function(){runBatch(bi+1);},BATCH_DELAY);
    });
  }
  runBatch(0);
}

// ‚îÄ‚îÄ SORT ‚îÄ‚îÄ
var COLS=['','score','sym','name','industry','bull','phase','coil','price','pch','mcap','pfh','pfl','pfath','range5d','range4w','adr','awr','daysFrH','daysFrL','e20','e50','e100','e200','c_100gt200','c_50gt100','c_20gt50','c_pgt20','wc_100gt200','wc_50gt100','wc_20gt50','wc_pgt20','s20','s50','s100','s200','todVol','wkAvg','moAvg','qtrAvgVol'];
function sortBy(col){
  sortCol===col?sortDir*=-1:(sortCol=col,sortDir=1);
  document.getElementById('colHeaders').querySelectorAll('th').forEach(function(th,i){
    th.className=th.className.replace(/ sort-(asc|desc)/g,'');
    if(COLS[i]===sortCol)th.className+=(sortDir===1?' sort-asc':' sort-desc');
  });
  try{localStorage.setItem('sp5sort',JSON.stringify({col:sortCol,dir:sortDir}));}catch(e){}
  renderTbl();
}
function loadSortPref(){
  try{
    var s=JSON.parse(localStorage.getItem('sp5sort'));
    if(s&&s.col){sortCol=s.col;sortDir=s.dir||1;
      // Restore header indicator after table renders
      setTimeout(function(){
        document.getElementById('colHeaders').querySelectorAll('th').forEach(function(th,i){
          th.className=th.className.replace(/ sort-(asc|desc)/g,'');
          if(COLS[i]===sortCol)th.className+=(sortDir===1?' sort-asc':' sort-desc');
        });
      },200);
    }
  }catch(e){}
}

// ‚îÄ‚îÄ FILTER HELPERS ‚îÄ‚îÄ
function gv(id){var el=document.getElementById(id);return el?el.value:'';}

// ‚îÄ‚îÄ SMART FILTER HELPERS ‚îÄ‚îÄ
// pctEMA20: (price - EMA20) / EMA20 * 100
function getPctEMA20(d){
  if(d.price==null||d.e20==null||d.e20===0)return null;
  return(d.price-d.e20)/d.e20*100;
}
// Volume ratio: today vol / monthly avg
function getVolRatio(d){
  if(!d.todVol||!d.moAvg||d.moAvg===0)return null;
  return d.todVol/d.moAvg;
}

function applyFilters(){updateFilterBadge();renderTbl();}

function clearAllFilters(){
  ['f_sym','f_name','f_industry','f_score','f_bull','f_phase','f_coil',
   'f_price','f_pch','f_mcap','f_pfh','f_pfl','f_range5d','f_range4w','f_adr','f_daysFrH','f_daysFrL',
   'f_c100gt200','f_c50gt100','f_c20gt50','f_cpgt20',
   'f_wc100gt200','f_wc50gt100','f_wc20gt50','f_wcpgt20','f_volratio_wk',
   'f_ret3m','f_rs','f_nr7','f_vdu'].forEach(function(id){
    var el=document.getElementById(id);if(el)el.value='';
  });
  clearSmartFilters();
  updateFilterBadge();renderTbl();
  toast('All filters cleared','ok');
}
function clearSmartFilters(){
  ['sf_pullback','sf_volratio','sf_bo52'].forEach(function(id){
    var el=document.getElementById(id);if(el)el.value='';
  });
  ['presetS2Bull','presetMomentum','presetCoilBO'].forEach(function(id){
    var el=document.getElementById(id);if(el)el.classList.remove('on');
  });
  document.getElementById('sfClearBtn').style.display='none';
  updateFilterBadge();renderTbl();
}
function applyPreset(name){
  // Clear smart filters first
  ['sf_pullback','sf_volratio','sf_bo52'].forEach(function(id){
    var el=document.getElementById(id);if(el)el.value='';
  });
  // Toggle off if already on
  var btn=document.getElementById('preset'+name.charAt(0).toUpperCase()+name.slice(1));
  // Find button by preset name
  var btnMap={s2bull:'presetS2Bull',momentum:'presetMomentum',coilbo:'presetCoilBO'};
  var btnEl=document.getElementById(btnMap[name]);
  var wasOn=btnEl&&btnEl.classList.contains('on');
  ['presetS2Bull','presetMomentum','presetCoilBO'].forEach(function(id){
    var el=document.getElementById(id);if(el)el.classList.remove('on');
  });
  if(wasOn){
    // Clear preset column filters too
    ['f_bull','f_phase','f_coil','f_c100gt200','f_c50gt100','f_c20gt50','f_cpgt20'].forEach(function(id){
      var el=document.getElementById(id);if(el)el.value='';
    });
    document.getElementById('sfClearBtn').style.display='none';
    updateFilterBadge();renderTbl();return;
  }
  if(btnEl)btnEl.classList.add('on');
  document.getElementById('sfClearBtn').style.display='';
  // Apply preset filters
  function setv(id,v){var el=document.getElementById(id);if(el)el.value=v;}
  if(name==='s2bull'){
    setv('f_bull','1');
    setv('f_phase','2');
    setv('f_score','60');      // Score ‚â• 60
    setv('f_c100gt200','1');
    setv('f_c50gt100','1');
    setv('f_c20gt50','1');
    setv('f_cpgt20','1');
  } else if(name==='momentum'){
    setv('f_bull','1');        // TREND = BULL
    setv('f_phase','2');       // S2 UP
    setv('sf_volratio','1.5'); // Vol >1.5x
    setv('sf_pullback','above_ema20'); // Price above EMA20
    setv('f_c100gt200','1');
    setv('f_c50gt100','1');
  } else if(name==='coilbo'){
    setv('f_coil','1');        // COIL = yes
    setv('f_pfh','near');      // Near 52W High
  }
  updateFilterBadge();renderTbl();
}

function updateFilterBadge(){
  var count=0;
  ['f_sym','f_name','f_industry'].forEach(function(id){if(gv(id).trim())count++;});
  ['f_score','f_bull','f_phase','f_coil','f_price','f_pch','f_mcap','f_pfh','f_pfl',
   'f_range5d','f_range4w','f_adr','f_daysFrH','f_daysFrL',
   'f_c100gt200','f_c50gt100','f_c20gt50','f_cpgt20',
   'f_wc100gt200','f_wc50gt100','f_wc20gt50','f_wcpgt20','f_volratio_wk',
   'f_ret3m','f_rs','f_nr7','f_vdu',
   'sf_pullback','sf_volratio','sf_bo52'].forEach(function(id){if(gv(id)!=='')count++;});
  var badge=document.getElementById('fBadge');
  var btn=document.getElementById('fClearBtn');
  if(count>0){badge.textContent=count+' filter'+(count>1?'s':'');badge.style.display='';btn.style.display='';}
  else{badge.style.display='none';btn.style.display='none';}
  // Highlight active selects
  ['f_score','f_bull','f_phase','f_coil','f_price','f_pch','f_mcap','f_pfh','f_pfl',
   'f_range5d','f_range4w','f_adr','f_daysFrH','f_daysFrL',
   'f_c100gt200','f_c50gt100','f_c20gt50','f_cpgt20',
   'f_wc100gt200','f_wc50gt100','f_wc20gt50','f_wcpgt20','f_volratio_wk',
   'f_ret3m','f_rs','f_nr7','f_vdu',
   'sf_pullback','sf_volratio','sf_bo52'].forEach(function(id){
    var el=document.getElementById(id);
    if(el)el.className=el.className.replace(/ act/g,'')+(el.value!==''?' act':'');
  });
  // Smart clear btn
  var sfAny=gv('sf_pullback')!==''||gv('sf_volratio')!==''||gv('sf_bo52')!=='';
  var sfBtn=document.getElementById('sfClearBtn');
  if(sfBtn){
    var hasPreset=['presetS2Bull','presetMomentum','presetCoilBO'].some(function(id){
      var el=document.getElementById(id);return el&&el.classList.contains('on');
    });
    sfBtn.style.display=(sfAny||hasPreset)?'':'none';
  }
}

// ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ
function filteredData(){
  var q=(document.getElementById('searchBox').value||'').toLowerCase().trim();
  var data=db.map(function(t){
    var d=Object.assign({},rows[t.sym]||{sym:t.sym});
    var meta=getInd(t.sym);
    if(meta.name&&!d.name)d.name=meta.name;
    d.industry=meta.industry||'';
    return d;
  });
  if(showWL)data=data.filter(function(d){return watchlist.has(d.sym);});
  if(q)data=data.filter(function(d){
    return d.sym.toLowerCase().indexOf(q)>=0
      ||(d.name||'').toLowerCase().indexOf(q)>=0
      ||(d.industry||'').toLowerCase().indexOf(q)>=0;
  });

  // ‚îÄ‚îÄ column text filters ‚îÄ‚îÄ
  var fSym=gv('f_sym').toUpperCase().trim();
  var fName=gv('f_name').toLowerCase().trim();
  var fInd=gv('f_industry').toLowerCase().trim();
  var fBull=gv('f_bull'),fPhase=gv('f_phase'),fCoil=gv('f_coil');
  var fPrice=gv('f_price'),fPch=gv('f_pch'),fMcap=gv('f_mcap');
  var fPfh=gv('f_pfh'),fPfl=gv('f_pfl');
  var fC100=gv('f_c100gt200'),fC50=gv('f_c50gt100'),fC20=gv('f_c20gt50'),fCp20=gv('f_cpgt20');
  var fWC100=gv('f_wc100gt200'),fWC50=gv('f_wc50gt100'),fWC20=gv('f_wc20gt50'),fWCp20=gv('f_wcpgt20');

  // ‚îÄ‚îÄ smart filters ‚îÄ‚îÄ
  var sfPullback=gv('sf_pullback'),sfVolRatio=gv('sf_volratio'),sfBo52=gv('sf_bo52');

  data=data.filter(function(d){
    // Always show loading rows
    if(d.loading)return true;
    // Text filters (apply even before price loaded)
    if(fSym&&d.sym.toUpperCase().indexOf(fSym)<0)return false;
    if(fName&&(d.name||'').toLowerCase().indexOf(fName)<0)return false;
    if(fInd&&(d.industry||'')!==fInd)return false;
    // Skip value filters for unloaded rows
    if(!d.price)return true;

    // ‚îÄ‚îÄ Categorical ‚îÄ‚îÄ
    if(fBull!==''&&String(d.bull)!==fBull)return false;
    if(fPhase!==''&&String(d.phase)!==fPhase)return false;
    if(fCoil!==''&&String(d.coil?1:0)!==fCoil)return false;
    if(fC100!==''&&String(d.c_100gt200?1:0)!==fC100)return false;
    if(fC50!==''&&String(d.c_50gt100?1:0)!==fC50)return false;
    if(fC20!==''&&String(d.c_20gt50?1:0)!==fC20)return false;
    if(fCp20!==''&&String(d.c_pgt20?1:0)!==fCp20)return false;
    // Weekly EMA conditions
    if(fWC100!==''&&String(d.wc_100gt200?1:0)!==fWC100)return false;
    if(fWC50!==''&&String(d.wc_50gt100?1:0)!==fWC50)return false;
    if(fWC20!==''&&String(d.wc_20gt50?1:0)!==fWC20)return false;
    if(fWCp20!==''&&String(d.wc_pgt20?1:0)!==fWCp20)return false;

    // ‚îÄ‚îÄ Price dropdown ‚îÄ‚îÄ
    if(fPrice){
      var rng=fPrice.split('-').map(Number);
      if(d.price<rng[0]||d.price>rng[1])return false;
    }
    // ‚îÄ‚îÄ % Day dropdown ‚îÄ‚îÄ
    if(fPch&&d.pch!=null){
      if(fPch==='up2'&&d.pch<=2)return false;
      if(fPch==='up1'&&d.pch<=1)return false;
      if(fPch==='dn1'&&d.pch>=-1)return false;
      if(fPch==='dn2'&&d.pch>=-2)return false;
      if(fPch==='flat'&&(d.pch<-1||d.pch>1))return false;
    }
    // ‚îÄ‚îÄ MCap dropdown ‚îÄ‚îÄ
    if(fMcap&&d.mcap!=null){
      if(fMcap==='large'&&d.mcap<20000)return false;
      if(fMcap==='mid'&&(d.mcap<5000||d.mcap>=20000))return false;
      if(fMcap==='small'&&(d.mcap<500||d.mcap>=5000))return false;
      if(fMcap==='micro'&&d.mcap>=500)return false;
    }
    // ‚îÄ‚îÄ % 52W High dropdown ‚îÄ‚îÄ
    if(fPfh&&d.pfh!=null){
      if(fPfh==='near'&&d.pfh<-5)return false;
      if(fPfh==='mid'&&(d.pfh<-10||d.pfh>=-5))return false;
      if(fPfh==='down'&&(d.pfh<-20||d.pfh>=-10))return false;
      if(fPfh==='deep'&&d.pfh>=-20)return false;
    }
    // ‚îÄ‚îÄ % 52W Low dropdown ‚îÄ‚îÄ
    if(fPfl&&d.pfl!=null){
      if(fPfl==='near'&&d.pfl>10)return false;
      if(fPfl==='mid'&&(d.pfl<=10||d.pfl>30))return false;
      if(fPfl==='far'&&(d.pfl<=30||d.pfl>80))return false;
      if(fPfl==='farther'&&d.pfl<=80)return false;
    }
    // ‚îÄ‚îÄ 5D Range dropdown ‚îÄ‚îÄ
    var fRange5d=gv('f_range5d');
    if(fRange5d&&d.range5d!=null){
      if(fRange5d==='tight'&&d.range5d>=1)return false;
      if(fRange5d==='coil'&&d.range5d>=2.5)return false;
      if(fRange5d==='mid'&&(d.range5d<2.5||d.range5d>=5))return false;
      if(fRange5d==='wide'&&d.range5d<5)return false;
    }
    // ‚îÄ‚îÄ 4W Range dropdown ‚îÄ‚îÄ
    var fRange4w=gv('f_range4w');
    if(fRange4w&&d.range4w!=null){
      if(fRange4w==='tight'&&d.range4w>=5)return false;
      if(fRange4w==='narrow'&&(d.range4w<5||d.range4w>=10))return false;
      if(fRange4w==='mid'&&(d.range4w<10||d.range4w>=20))return false;
      if(fRange4w==='wide'&&d.range4w<20)return false;
    }
    // ‚îÄ‚îÄ ADR filter ‚îÄ‚îÄ
    var fAdr=gv('f_adr');
    if(fAdr&&d.adr!=null){
      if(fAdr==='tight'&&d.adr>=1)return false;
      if(fAdr==='mid'&&(d.adr<1||d.adr>=3))return false;
      if(fAdr==='wide'&&d.adr<3)return false;
    }
    // ‚îÄ‚îÄ Days from 52W H/L filters ‚îÄ‚îÄ
    var fDfH=gv('f_daysFrH'),fDfL=gv('f_daysFrL');
    if(fDfH&&d.daysFrH!=null){
      if(fDfH==='fresh'&&d.daysFrH>=20)return false;
      if(fDfH==='mid'&&(d.daysFrH<20||d.daysFrH>=60))return false;
      if(fDfH==='old'&&d.daysFrH<60)return false;
    }
    if(fDfL&&d.daysFrL!=null){
      if(fDfL==='fresh'&&d.daysFrL>=20)return false;
      if(fDfL==='mid'&&(d.daysFrL<20||d.daysFrL>=60))return false;
      if(fDfL==='old'&&d.daysFrL<60)return false;
    }
    // ‚îÄ‚îÄ Vol ratio wk/qtr dropdown ‚îÄ‚îÄ
    var fVolRatioWk=gv('f_volratio_wk');
    if(fVolRatioWk&&d.volRatio!=null){
      var fvr=parseFloat(fVolRatioWk);
      if(fVolRatioWk==='0.5'&&d.volRatio>=0.5)return false;
      if(fVolRatioWk!=='0.5'&&d.volRatio<fvr)return false;
    }

    // ‚îÄ‚îÄ SMART: % vs EMA20 pullback ‚îÄ‚îÄ
    if(sfPullback){
      var pema20=getPctEMA20(d);
      if(pema20==null)return false;
      if(sfPullback==='pullback1'&&(pema20<-1||pema20>0))return false;
      if(sfPullback==='pullback3'&&(pema20<-3||pema20>0))return false;
      if(sfPullback==='pullback5'&&(pema20<-5||pema20>0))return false;
      if(sfPullback==='above_ema20'&&pema20<=0)return false;
      if(sfPullback==='below_ema20'&&pema20>=0)return false;
    }
    // ‚îÄ‚îÄ SMART: Volume ratio ‚îÄ‚îÄ
    if(sfVolRatio){
      var vr=getVolRatio(d);
      if(vr==null||vr<parseFloat(sfVolRatio))return false;
    }
    // ‚îÄ‚îÄ SMART: 52W Breakout ‚îÄ‚îÄ
    if(sfBo52){
      if(sfBo52==='near'&&!(d.pfh!=null&&d.pfh>=-2&&d.pfh<=0))return false;
      if(sfBo52==='at'&&!d.bo52h)return false;
    }
    // Score filter
    var fScore=gv('f_score');
    if(fScore){
      var sv=parseFloat(fScore);
      if(fScore==='20'){if((d.score||0)>=20)return false;}
      else if((d.score||0)<sv)return false;
    }
    // 3M return filter
    var fRet3m=gv('f_ret3m');
    if(fRet3m&&d.ret3m!=null){
      if(fRet3m==='neg'&&d.ret3m>=0)return false;
      else if(fRet3m!=='neg'&&d.ret3m<parseFloat(fRet3m))return false;
    }
    // RS vs Nifty filter
    var fRs=gv('f_rs');
    if(fRs&&d.rsNifty!=null){
      if(fRs==='under'&&d.rsNifty>=1)return false;
      else if(fRs!=='under'&&d.rsNifty<parseFloat(fRs))return false;
    }
    // NR7 filter
    var fNr7=gv('f_nr7');
    if(fNr7==='1'&&!d.nr7)return false;
    // Vol dry-up filter
    var fVdu=gv('f_vdu');
    if(fVdu==='1'&&!d.volDryUp)return false;

    return true;
  });

  if(sortCol){
    data.sort(function(a,b){
      var av=a[sortCol],bv=b[sortCol];
      if(av==null||av==='')return 1;if(bv==null||bv==='')return -1;
      if(typeof av==='boolean')av=av?1:0;if(typeof bv==='boolean')bv=bv?1:0;
      if(typeof av==='string')return av.localeCompare(bv)*sortDir;
      return(av-bv)*sortDir;
    });
  }
  return data;
}
// ‚îÄ‚îÄ RENDER HELPERS ‚îÄ‚îÄ
// EMA cross signal badge ‚Äî shows ‚Üë/‚Üì if price crossed this EMA today
function emaSigFor(d, label){
  if(!d.emaCrossSignals||!d.emaCrossSignals.length)return '';
  var sig=d.emaCrossSignals.find(function(s){return s.ema===label;});
  if(!sig)return '';
  if(sig.dir==='up')return '<br><span class="ema-sig ema-sig-up">‚Üë crossed up</span>';
  return '<br><span class="ema-sig ema-sig-dn">‚Üì crossed dn</span>';
}
// Range cell ‚Äî color-coded: tight=green, wide=red
function rngCell(v){
  var cls=v<2.5?'up':v<5?'mu':v<10?'':'dn';
  return '<span class="'+(cls||'mu')+'" style="font-size:11px">'+v.toFixed(1)+'%</span>';
}
// Quarter vol cell ‚Äî shows wkAvg/qtrAvg ratio
function qtrVolCell(d){
  if(!d.qtrAvgVol)return '<span class="mu">-</span>';
  var ratio=d.volRatio;
  var qtrStr=fmtVol(d.qtrAvgVol);
  if(ratio==null)return '<span class="vr-norm">'+qtrStr+'</span>';
  var cls=ratio>=1.5?'vr-hot':'vr-norm';
  var icon=ratio>=2?'üî•':ratio>=1.5?'‚Üë':'';
  return '<span class="'+cls+'">'+qtrStr+'</span><span style="font-size:9px;color:var(--mu);margin-left:3px">'+icon+(ratio>=0.5?ratio.toFixed(1)+'x':'')+'</span>';
}
// Stronger 52W high color: very close (<1%) = hot orange, very far (>30%) = deep red
function pfhCell(d){
  if(d.pfh==null)return '<span class="mu">-</span>';
  var pct=d.pfh;
  var boTag=d.bo52h?'<span class="t-brk52">52W BO&#x1F525;</span>':'';
  var pctStr=(pct>=0?'+':'')+pct.toFixed(1)+'%';
  var cls;
  if(d.bo52h||pct>=-1)cls='pct-hi-close';       // ‚â• -1% = very close = hot
  else if(pct<-30)cls='pct-hi-far';              // < -30% = deep = muted red
  else cls='pct-hi';                              // normal
  return '<span class="'+cls+'">'+pctStr+'</span>'+boTag;
}
// Stronger 52W low color: very close (<5%) = danger cyan, very far (>80%) = strong green
function pflCell(d){
  if(d.pfl==null)return '<span class="mu">-</span>';
  var pct=d.pfl;
  var brkTag=d.bo52l?'<span class="t-brkdn">52W DN&#x26A0;</span>':'';
  var pctStr=(pct>=0?'+':'')+pct.toFixed(1)+'%';
  var cls;
  if(d.bo52l||pct<=5)cls='pct-lo-close';        // ‚â§ 5% from low = near danger
  else if(pct>80)cls='pct-lo-far';              // > 80% = strong uptrend
  else cls='pct-lo';
  return '<span class="'+cls+'">'+pctStr+'</span>'+brkTag;
}
// ADR cell ‚Äî color by tightness
function adrCell(v){
  if(v==null)return '<span class="mu">-</span>';
  var cls=v<1?'adr-tight':v<3?'adr-mid':'adr-wide';
  return '<span class="'+cls+'">'+v.toFixed(1)+'%</span>';
}
// Days from 52W high/low ‚Äî longer = trend weakening
function daysFrCell(days, isHigh){
  if(days==null)return '<span class="mu">-</span>';
  var cls='pb-tag';
  var label=days+'d';
  // High: longer days = trend weakened; Low: longer days = recovery
  if(isHigh){cls+=(days>60?' warn':days<10?' ok':'');}
  else{cls+=(days<10?' warn':days>60?' ok':'');}
  return '<span class="'+cls+'">'+label+'</span>';
}
// Weekly EMA condition yn
function wYn(v){
  if(v===null||v===undefined)return '<span class="mu">-</span>';
  return v?'<span class="wyes">YES</span>':'<span class="wno">NO</span>';
}
// Score badge
function scoreCell(s){
  if(s==null)return '<span class="mu">-</span>';
  var cls=s>=80?'score-hi':s>=50?'score-mid':'score-lo';
  return '<span class="'+cls+'">'+s+'</span>';
}
// Return % cell
function retCell(v){
  if(v==null)return '<span class="mu">-</span>';
  var cls=v>=20?'ret-hi':v>=0?'ret-mid':'ret-lo';
  return '<span class="'+cls+'">'+(v>=0?'+':'')+v.toFixed(1)+'%</span>';
}
// RS vs Nifty
function rsCell(v){
  if(v==null)return '<span class="mu">‚Äî</span>';
  var cls=v>=1.2?'rs-hi':v>=1?'rs-mid':'rs-lo';
  return '<span class="'+cls+'">'+v.toFixed(2)+'x</span>';
}
// Consecutive days
function consecCell(v){
  if(!v)return '<span class="mu">‚Äî</span>';
  var cls=v>0?'consec-up':'consec-dn';
  return '<span class="'+cls+'">'+(v>0?'‚Üë'+v+'d':'‚Üì'+Math.abs(v)+'d')+'</span>';
}
function yn(v){
  if(v===null||v===undefined)return '<span class="mu">-</span>';
  return v?'<span class="yes">YES</span>':'<span class="no">NO</span>';
}
function streak(v){
  if(!v)return '<span class="streak-0">‚Äî</span>';
  return v>0?'<span class="streak-up">‚Üë'+Math.abs(v)+'d</span>':'<span class="streak-dn">‚Üì'+Math.abs(v)+'d</span>';
}
function ep(v){return v!=null?'<span class="ev">‚Çπ'+fmt(v)+'</span>':'<span class="mu">-</span>';}
function bullCell(v){
  if(v===null||v===undefined)return '<span class="mu">-</span>';
  if(v===1)return '<span class="t-bull">‚ñ≤ BULL</span>';
  if(v===-1)return '<span class="t-bear">‚ñº BEAR</span>';
  return '<span class="t-mix">~ MIX</span>';
}
function phaseCell(v){
  if(v==null)return '<span class="mu">-</span>';
  var lbl=['','S1 BASE','S2 UP','S3 TOP','S4 DN'],cls=['','t-s1','t-s2','t-s3','t-s4'];
  return '<span class="'+cls[v]+'">'+lbl[v]+'</span>';
}
function coilCell(coil,range5d){
  if(range5d==null)return '<span class="mu">-</span>';
  if(coil)return '<span class="t-coil">üåÄ COIL</span><span style="font-size:9px;color:var(--mu);margin-left:3px">'+range5d.toFixed(1)+'%</span>';
  return '<span class="mu" style="font-size:11px">'+range5d.toFixed(1)+'%</span>';
}
function cross200Cell(v,price,e200){
  if(!v)return '<span class="mu">-</span>';
  if(v==='up')return '<span class="t-cup">‚Üë CROSS UP</span>';
  return '<span class="t-cdn">‚Üì CROSS DN</span>';
}
function fmtVol(v){
  if(!v)return '-';
  if(v>=1e7)return (v/1e7).toFixed(1)+'Cr';
  if(v>=1e5)return (v/1e5).toFixed(1)+'L';
  if(v>=1e3)return (v/1e3).toFixed(0)+'K';
  return String(Math.round(v));
}
function volCell(d){
  if(!d.todVol)return '<span class="mu">-</span>';
  var hiW=d.wkAvg&&d.todVol>d.wkAvg,hiM=d.moAvg&&d.todVol>d.moAvg;
  var tag='';
  if(d.volSpike)tag='<span class="t-spike">2x‚ö°</span>';
  else if(hiW&&hiM)tag='<span class="vol-tag">W+M‚Üë</span>';
  else if(hiW)tag='<span class="vol-tag">WK‚Üë</span>';
  else if(hiM)tag='<span class="vol-tag">MO‚Üë</span>';
  return '<span class="'+(d.volSpike?'vol-hi':hiW||hiM?'vol-hi':'vol-lo')+'">'+fmtVol(d.todVol)+tag+'</span>';
}

// ‚îÄ‚îÄ RENDER TABLE ‚îÄ‚îÄ
function renderTbl(){
  var data=filteredData();
  var isEmpty=!db.length,isWLEmpty=showWL&&!data.length&&db.length>0;
  document.getElementById('tbl').style.display=(isEmpty||isWLEmpty)?'none':'';
  document.getElementById('empty').style.display=isEmpty?'block':'none';
  document.getElementById('wlEmpty').style.display=isWLEmpty?'block':'none';
  if(isEmpty||isWLEmpty)return;
  var h='';
  data.forEach(function(d){
    var sym=d.sym,s=sym.replace(/\.(NS|BO)$/,''),xt=sym.endsWith('.BO')?'.BO':'.NS';
    var starred=watchlist.has(sym);
    var starTd='<td class="wl-col"><span class="star'+(starred?' on':'')+'" onclick="toggleStar(\''+sym+'\')">'+(starred?'‚òÖ':'‚òÜ')+'</span></td>';
    var symTd='<td style="text-align:left"><span class="sym">'+s+'</span><span class="xt">'+xt+'</span></td>';
    var indTd='<td style="text-align:left"><span class="ni">'+esc(d.industry||'‚Äî')+'</span></td>';
    if(d.loading){
      h+='<tr>'+starTd+'<td></td>'+symTd+'<td style="text-align:left"><span class="nc">'+esc(d.name||'')+'</span></td>'+indTd+'<td colspan="41" class="ld">‚ü≥ fetching...</td></tr>';
    } else if(d.err){
      h+='<tr>'+starTd+'<td></td>'+symTd+'<td style="text-align:left"><span class="nc">'+esc(d.name||'')+'</span></td>'+indTd+'<td colspan="41" class="er">‚úó '+esc(d.err)+'</td></tr>';
    } else if(!d.price){
      h+='<tr>'+starTd+'<td></td>'+symTd+'<td style="text-align:left"><span class="nc">'+esc(d.name||'')+'</span></td>'+indTd+'<td colspan="41" class="ld">‚Äî</td></tr>';
    } else {
      var pc=d.pch==null?'<span class="mu">-</span>':'<span class="'+(d.pch>=0?'up':'dn')+'">'+(d.pch>=0?'+':'')+d.pch.toFixed(2)+'%</span>';
      var pfhHtml=pfhCell(d);
      var pflHtml=pflCell(d);
      var athCell=d.pfath!=null
        ?'<span class="pct-ath">'+(d.pfath>=0?'+':'')+d.pfath.toFixed(1)+'%</span>'
        :'<span class="mu">-</span>';
      // 200 EMA cross shown in EMA200 cell
      var e200Cell=ep(d.e200)+(d.cross200?'<br>'+cross200Cell(d.cross200):'');
      var _isUpd=d._fetchedDate===_todayDate;
      h+=(_isUpd?'<tr class="row-updated"':'<tr>')
        +starTd
        +'<td>'+scoreCell(d.score)+'</td>'
        +symTd
        +'<td style="text-align:left"><span class="nc">'+esc(d.name)+'</span></td>'
        +indTd
        +'<td>'+bullCell(d.bull)+'</td>'
        +'<td>'+phaseCell(d.phase)+'</td>'
        +'<td>'+coilCell(d.coil,d.range5d)+'</td>'
        +'<td>‚Çπ'+fmt(d.price)+'</td>'
        +'<td>'+pc+'</td>'
        +'<td class="mu">'+(d.mcap?fCr(d.mcap):'-')+'</td>'
        +'<td>'+pfhHtml+'</td>'
        +'<td>'+pflHtml+'</td>'
        +'<td>'+athCell+'</td>'
        +'<td>'+(d.range5d!=null?rngCell(d.range5d):'<span class="mu">-</span>')+'</td>'
        +'<td>'+(d.range4w!=null?rngCell(d.range4w):'<span class="mu">-</span>')+'</td>'
        +'<td>'+adrCell(d.adr)+'</td>'
        +'<td>'+(d.awr!=null?'<span class="adr-mid">'+d.awr.toFixed(1)+'%</span>':'<span class="mu">-</span>')+'</td>'
        +'<td>'+daysFrCell(d.daysFrH,true)+'</td>'
        +'<td>'+daysFrCell(d.daysFrL,false)+'</td>'
        +'<td class="sec-border">'+ep(d.e20)+emaSigFor(d,"EMA20")+'</td>'
        +'<td>'+ep(d.e50)+emaSigFor(d,"EMA50")+'</td>'
        +'<td>'+ep(d.e100)+emaSigFor(d,"EMA100")+'</td>'
        +'<td>'+e200Cell+emaSigFor(d,"EMA200")+'</td>'
        +'<td class="sec-border">'+yn(d.c_100gt200)+'</td>'
        +'<td>'+yn(d.c_50gt100)+'</td>'
        +'<td>'+yn(d.c_20gt50)+'</td>'
        +'<td>'+yn(d.c_pgt20)+'</td>'
        +'<td class="sec-border">'+wYn(d.wc_100gt200)+'</td>'
        +'<td>'+wYn(d.wc_50gt100)+'</td>'
        +'<td>'+wYn(d.wc_20gt50)+'</td>'
        +'<td>'+wYn(d.wc_pgt20)+'</td>'
        +'<td class="sec-border">'+streak(d.s20)+'</td>'
        +'<td>'+streak(d.s50)+'</td>'
        +'<td>'+streak(d.s100)+'</td>'
        +'<td>'+streak(d.s200)+'</td>'
        +'<td class="sec-border">'+volCell(d)+'</td>'
        +'<td class="mu">'+fmtVol(d.wkAvg)+'</td>'
        +'<td class="mu">'+fmtVol(d.moAvg)+'</td>'
        +'<td>'+qtrVolCell(d)+'</td>'
        +'<td class="sec-border">'+retCell(d.ret1m)+'</td>'
        +'<td>'+retCell(d.ret3m)+'</td>'
        +'<td>'+retCell(d.ret6m)+'</td>'
        +'<td>'+rsCell(d.rsNifty)+'</td>'
        +'<td>'+consecCell(d.consec)+(d.volDryUp?'<span class="t-vdu" title="Volume Dry-Up: low vol = possible coil">VDU</span>':'')+(d.nr7?'<span class="t-nr7" title="Narrowest Range in 7 Days">NR7</span>':'')+'</td>'
        +'<td>'+(d.nr7?'<span class="t-nr7">NR7</span>':'<span class="mu">‚Äî</span>')+'</td>'
        +'</tr>';
    }
  });
  document.getElementById('tb').innerHTML=h;
  populateIndustryDropdown();
}
function populateIndustryDropdown(){
  var sel=document.getElementById('f_industry');
  if(!sel)return;
  var cur=sel.value;
  // collect unique non-empty industries from loaded rows
  var set={};
  db.forEach(function(t){
    var meta=getInd(t.sym);
    var ind=meta.industry||(rows[t.sym]&&rows[t.sym].industry)||'';
    if(ind)set[ind]=1;
  });
  var inds=Object.keys(set).sort();
  var h='<option value="">All Industries</option>';
  inds.forEach(function(ind){
    h+='<option value="'+esc(ind)+'"'+(ind===cur?' selected':'')+'>'+esc(ind)+'</option>';
  });
  sel.innerHTML=h;
}

function retryErrors(){
  var errSyms=db.filter(function(t){return rows[t.sym]&&rows[t.sym].err;}).map(function(t){return t.sym;});
  if(!errSyms.length){toast('No errors to retry','');return;}
  errSyms.forEach(function(sym){delete rows[sym];});
  renderTbl();
  toast('Retrying '+errSyms.length+' stocks...','ok');
  go(errSyms);
}
function clearT(){rows={};renderTbl();document.getElementById('sbar').className='';toast('Table cleared','');}

// ‚îÄ‚îÄ STATS ‚îÄ‚îÄ
function updateStats(){
  var all=Object.values(rows);
  document.getElementById('st').textContent=db.length;
  document.getElementById('sok').textContent=all.filter(function(d){return d&&d.price;}).length;
  document.getElementById('ser').textContent=all.filter(function(d){return d&&d.err;}).length;
  renderDb(); // keep invalid badge in sync
}
function setP(d,t){document.getElementById('prog').textContent=d+' / '+t;}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
var EXP_K=['score','sym','name','industry','bull','phase','coil','price','pch','mcap','pfh','pfl','pfath','range5d','range4w','adr','awr','daysFrH','daysFrL','hi52','lo52','ath','e20','e50','e100','e200','c_100gt200','c_50gt100','c_20gt50','c_pgt20','wc_100gt200','wc_50gt100','wc_20gt50','wc_pgt20','s20','s50','s100','s200','todVol','wkAvg','moAvg','qtrAvgVol','volRatio','ret1m','ret3m','ret6m','rsNifty','nr7','consec','volDryUp','bo52h','bo52l','volSpike','cross200'];
var EXP_H=['Score','Symbol','Name','Industry','Trend','Phase','Coil','Price','%Day','MCap_Cr','%52W_H','%52W_L','%5Y_H','5D_Rng%','4W_Rng%','ADR%','AWR%','DaysFr52H','DaysFr52L','52W_High','52W_Low','5Y_High','EMA20','EMA50','EMA100','EMA200','100>200','50>100','20>50','P>20','W:100>200','W:50>100','W:20>50','W:P>20','Days_vs20','Days_vs50','Days_vs100','Days_vs200','TodayVol','WkAvgVol','MoAvgVol','QtrAvgVol','WkVsQtrRatio','Ret1M%','Ret3M%','Ret6M%','RS_Nifty','NR7','ConsecDays','VolDryUp','52W_BO','52W_BrkDn','VolSpike','Cross200EMA'];
function bullStr(v){return v===1?'BULL':v===-1?'BEAR':'MIX';}
function phaseStr(v){var l=['','S1_BASE','S2_UP','S3_TOP','S4_DOWN'];return v!=null?l[v]:'';}
function rowToArr(d){
  return EXP_K.map(function(k){
    var v=k==='industry'?getInd(d.sym).industry||'':d[k];
    if(v===null||v===undefined)return '';
    if(k==='bull')return bullStr(v);
    if(k==='phase')return phaseStr(v);
    if(typeof v==='boolean')return v?'YES':'NO';
    if(typeof v==='number')return parseFloat(v.toFixed(2));
    return v;
  });
}
function exportCSV(){
  var data=filteredData().filter(function(d){return d.price;});
  if(!data.length){toast('No data to export','er');return;}
  var r=[EXP_H].concat(data.map(rowToArr));
  var csv=r.map(function(row){return row.map(function(v){var s=String(v);return s.indexOf(',')>=0||s.indexOf('"')>=0?'"'+s.replace(/"/g,'""')+'"':s;}).join(',');}).join('\n');
  dl('StockPulse_'+today()+'.csv','data:text/csv;charset=utf-8,'+encodeURIComponent(csv));
  toast('CSV exported','ok');
}
function exportExcel(){
  var data=filteredData().filter(function(d){return d.price;});
  if(!data.length){toast('No data to export','er');return;}
  var xml='<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?><Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"><Worksheet ss:Name="StockPulse"><Table>';
  xml+='<Row>'+EXP_H.map(function(h){return '<Cell><Data ss:Type="String">'+h+'</Data></Cell>';}).join('')+'</Row>';
  data.forEach(function(d){xml+='<Row>'+rowToArr(d).map(function(v){var t=typeof v==='number'?'Number':'String';return '<Cell><Data ss:Type="'+t+'">'+String(v).replace(/&/g,'&amp;').replace(/</g,'&lt;')+'</Data></Cell>';}).join('')+'</Row>';});
  xml+='</Table></Worksheet></Workbook>';
  dl('StockPulse_'+today()+'.xls','data:application/vnd.ms-excel;charset=utf-8,'+encodeURIComponent(xml));
  toast('Excel exported','ok');
}
function dl(fname,href){var a=document.createElement('a');a.href=href;a.download=fname;document.body.appendChild(a);a.click();document.body.removeChild(a);}
function today(){return new Date().toISOString().slice(0,10);}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;');}
function fmt(v){return v?v.toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}):'-';}
function fCr(v){return v>=1e5?(v/1e5).toFixed(1)+' LCr':v>=1e3?(v/1e3).toFixed(1)+' KCr':v.toFixed(0)+' Cr';}
var _tt;
function toast(msg,t){var el=document.getElementById('toast');el.textContent=msg;el.className='show'+(t?' '+t:'');clearTimeout(_tt);_tt=setTimeout(function(){el.className='';},3500);}

// ‚îÄ‚îÄ THEME TOGGLE ‚îÄ‚îÄ
function toggleTheme(){
  var isLight=document.body.classList.toggle('light');
  document.getElementById('themeBtn').textContent=isLight?'üåô Dark':'‚òÄ Light';
  try{localStorage.setItem('sp5theme',isLight?'light':'dark');}catch(e){}
}
function loadTheme(){
  try{
    var t=localStorage.getItem('sp5theme');
    if(t==='light'){document.body.classList.add('light');document.getElementById('themeBtn').textContent='üåô Dark';}
  }catch(e){}
}

// ‚îÄ‚îÄ COLUMN VISIBILITY ‚îÄ‚îÄ
var CV_KEY='sp5colvis';
// Map: group id ‚Üí array of column indices that it controls
// Cols: 0=star 1=sym 2=name 3=ind 4=trend 5=phase 6=coil 7=price 8=pch 9=mcap 10=pfh 11=pfl 12=pfath 13=rng5 14=rng4 15=adr 16=awr 17=dfH 18=dfL 19=e20 20=e50 21=e100 22=e200 23=c1 24=c2 25=c3 26=c4 27=wc1 28=wc2 29=wc3 30=wc4 31=s20 32=s50 33=s100 34=s200 35=tvol 36=wvol 37=mvol 38=qvol
var COL_VIS_MAP={
  cv_score:[1],
  cv_industry:[4],
  cv_trend:[5],cv_phase:[6],cv_coil:[7],
  cv_pch:[9],cv_mcap:[10],
  cv_52w:[11,12],cv_5yh:[13],
  cv_rng:[14,15],cv_adr:[16,17],cv_pb52:[18,19],
  cv_ema_vals:[20,21,22,23],
  cv_ema_cond:[24,25,26,27],
  cv_wema:[28,29,30,31],
  cv_streaks:[32,33,34,35],
  cv_vol:[36,37,38,39],
  cv_momentum:[40,41,42,43,44,45]
};
function toggleColVis(){
  document.getElementById('colVisPanel').classList.toggle('on');
}
function applyColVis(){
  var state={};
  Object.keys(COL_VIS_MAP).forEach(function(id){
    var el=document.getElementById(id);
    var visible=el?el.checked:true;
    state[id]=visible;
    var cols=COL_VIS_MAP[id];
    cols.forEach(function(ci){
      // Apply to all rows via CSS class on col
      setColVisible(ci,visible);
    });
  });
  // hg1 group spans ‚Äî handle by toggling EMA COND / WEEKLY COND header visibility
  var wemaEl=document.getElementById('hg1_wema');
  if(wemaEl)wemaEl.style.display=state.cv_wema===false?'none':'';
  var ecEl=document.getElementById('hg1_emacond');
  if(ecEl)ecEl.style.display=state.cv_ema_cond===false?'none':'';
  try{localStorage.setItem(CV_KEY,JSON.stringify(state));}catch(e){}
}
function setColVisible(colIdx,visible){
  // colIdx is 1-based for nth-child (we add 1 because filter row/header also uses nth-child)
  var ci=colIdx+1; // CSS nth-child is 1-based
  var styleId='cv-style-'+colIdx;
  var el=document.getElementById(styleId);
  if(!visible){
    if(!el){
      el=document.createElement('style');el.id=styleId;document.head.appendChild(el);
    }
    el.textContent='#tbl td:nth-child('+ci+'),#tbl th:nth-child('+ci+'){display:none!important;}';
  } else {
    if(el){el.textContent='';}
  }
}
function loadColVis(){
  try{
    var state=JSON.parse(localStorage.getItem(CV_KEY));
    if(!state)return;
    Object.keys(COL_VIS_MAP).forEach(function(id){
      var el=document.getElementById(id);
      if(el&&state[id]===false)el.checked=false;
    });
    applyColVis();
  }catch(e){}
}
function resetColVis(){
  Object.keys(COL_VIS_MAP).forEach(function(id){
    var el=document.getElementById(id);
    if(el)el.checked=true;
  });
  applyColVis();
  toast('Columns reset to default','ok');
}

// ‚îÄ‚îÄ EXPORT VISIBLE COLUMNS ONLY ‚îÄ‚îÄ
function exportVisibleCSV(){
  var data=filteredData().filter(function(d){return d.price;});
  if(!data.length){toast('No data to export','er');return;}
  // Determine visible column indices from COL_VIS_MAP checkboxes
  var hiddenGroups=[];
  Object.keys(COL_VIS_MAP).forEach(function(id){
    var el=document.getElementById(id);
    if(el&&!el.checked)hiddenGroups=hiddenGroups.concat(COL_VIS_MAP[id]);
  });
  // Map COLS indices to EXP_K ‚Äî filter out hidden ones
  // Export all key/header pairs that aren't in hidden column groups
  // We use a simpler approach: just export based on which EXP_K fields correspond to hidden cols
  var hiddenFields=[];
  var colGroupFieldMap={
    cv_industry:['industry'],cv_trend:['bull'],cv_phase:['phase'],cv_coil:['coil','range5d'],
    cv_pch:['pch'],cv_mcap:['mcap'],cv_52w:['pfh','pfl','hi52','lo52','bo52h','bo52l'],
    cv_5yh:['pfath','ath'],cv_rng:['range5d','range4w'],cv_adr:['adr','awr'],
    cv_pb52:['daysFrH','daysFrL'],cv_ema_vals:['e20','e50','e100','e200'],
    cv_ema_cond:['c_100gt200','c_50gt100','c_20gt50','c_pgt20'],
    cv_wema:['wc_100gt200','wc_50gt100','wc_20gt50','wc_pgt20'],
    cv_streaks:['s20','s50','s100','s200'],
    cv_vol:['todVol','wkAvg','moAvg','qtrAvgVol','volRatio','volSpike']
  };
  Object.keys(colGroupFieldMap).forEach(function(id){
    var el=document.getElementById(id);
    if(el&&!el.checked)hiddenFields=hiddenFields.concat(colGroupFieldMap[id]);
  });
  var visibleK=[],visibleH=[];
  EXP_K.forEach(function(k,i){
    if(hiddenFields.indexOf(k)<0){visibleK.push(k);visibleH.push(EXP_H[i]);}
  });
  var rows=[visibleH].concat(data.map(function(d){
    return visibleK.map(function(k){
      var v=k==='industry'?getInd(d.sym).industry||'':d[k];
      if(v===null||v===undefined)return '';
      if(k==='bull')return bullStr(v);
      if(k==='phase')return phaseStr(v);
      if(typeof v==='boolean')return v?'YES':'NO';
      if(typeof v==='number')return parseFloat(v.toFixed(2));
      return v;
    });
  }));
  var csv=rows.map(function(row){return row.map(function(v){var s=String(v);return s.indexOf(',')>=0||s.indexOf('"')>=0?'"'+s.replace(/"/g,'""')+'"':s;}).join(',');}).join('\n');
  dl('StockPulse_Visible_'+today()+'.csv','data:text/csv;charset=utf-8,'+encodeURIComponent(csv));
  toast('Visible columns exported','ok');
}

// ‚îÄ‚îÄ PAGINATION ‚îÄ‚îÄ
function renderPagination(total,totalPages){
  var bar=document.getElementById('paginationBar');
  if(total===0){bar.className='';return;}
  bar.className='on';
  var start=(pgPage-1)*pgSize+1;
  var end=Math.min(pgPage*pgSize,total);
  // Info
  document.getElementById('pgInfo').innerHTML=
    'Showing <strong>'+start+'&ndash;'+end+'</strong> of <strong>'+total+'</strong> stocks &nbsp;¬∑&nbsp; Page <strong>'+pgPage+'</strong> of <strong>'+totalPages+'</strong>';
  // Controls
  var pg=document.getElementById('pgControls');
  var h='<button class="pg-btn" onclick="goPg(1)" '+(pgPage<=1?'disabled':'')+'>¬´</button>';
  h+='<button class="pg-btn" onclick="goPg('+( pgPage-1)+')" '+(pgPage<=1?'disabled':'')+'>‚Äπ Prev</button>';
  // Window of pages
  var win=5,s=Math.max(1,pgPage-2),e=Math.min(totalPages,s+win-1);
  if(e-s<win-1)s=Math.max(1,e-win+1);
  if(s>1)h+='<span class="pg-btn" style="cursor:default;opacity:.4">‚Ä¶</span>';
  for(var i=s;i<=e;i++){
    h+='<button class="pg-btn'+(i===pgPage?' on':'')+'" onclick="goPg('+i+')">'+(i)+'</button>';
  }
  if(e<totalPages)h+='<span class="pg-btn" style="cursor:default;opacity:.4">‚Ä¶</span>';
  h+='<button class="pg-btn" onclick="goPg('+( pgPage+1)+')" '+(pgPage>=totalPages?'disabled':'')+'>Next ‚Ä∫</button>';
  h+='<button class="pg-btn" onclick="goPg('+totalPages+')" '+(pgPage>=totalPages?'disabled':'')+'>¬ª</button>';
  pg.innerHTML=h;
}
function goPg(p){
  if(p<1||isNaN(p))return;
  pgPage=p;
  renderTbl();
  // Scroll table to top
  document.getElementById('twrap').scrollTop=0;
}
function setPgSize(n){pgSize=parseInt(n);pgPage=1;renderTbl();}

// ‚îÄ‚îÄ STICKY SCROLL SYNC ‚îÄ‚îÄ
function initScrollSync(){
  var hs=document.getElementById('hscroll');
  var tw=document.getElementById('twrap');
  var hi=document.getElementById('hscrollInner');
  function syncW(){hi.style.width=tw.scrollWidth+'px';}
  syncW();
  // keep width in sync when table changes
  var mo=new MutationObserver(syncW);
  mo.observe(tw,{childList:true,subtree:true});
  window.addEventListener('resize',syncW);
  var syncing=false;
  hs.addEventListener('scroll',function(){if(syncing)return;syncing=true;tw.scrollLeft=hs.scrollLeft;syncing=false;});
  tw.addEventListener('scroll',function(){if(syncing)return;syncing=true;hs.scrollLeft=tw.scrollLeft;syncing=false;});
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
function bootstrap(){
  wlLoad();indLoad();loadTheme();loadColVis();loadSortPref();
  load(); // load user's own DB from localStorage

  // Show loading state immediately
  document.getElementById('empty').innerHTML=
    '<div style="color:var(--mu2);font-size:13px">‚ü≥ Loading stock list‚Ä¶</div>';

  // Fetch tickers.json ‚Äî controls the default list for all visitors
  fetch('/tickers.json?v='+Date.now())
    .then(function(r){
      if(!r.ok)throw new Error('tickers.json not found (HTTP '+r.status+')');
      return r.json();
    })
    .then(function(list){
      DEFAULT_LIST=list;
      seedDefaultList(list);
      finishInit();
    })
    .catch(function(err){
      // tickers.json missing ‚Äî still work with user's own DB if any
      console.warn('tickers.json:',err.message);
      if(!db.length){
        document.getElementById('empty').innerHTML=
          '<div style="color:var(--red);font-size:12px">‚ö† tickers.json not found in repo.<br>Add the file to GitHub or add tickers manually above.</div>';
      }
      finishInit();
    });
}

function finishInit(){
  db.forEach(function(t){var cached=cacheGet(t.sym);if(cached)rows[t.sym]=cached;});
  renderDb();renderTbl();updateStats();updateCacheNote();updateWLCount();
  if(Object.keys(rows).length){
    document.getElementById('sbar').className='on';
    document.getElementById('tbl').style.display='';
    document.getElementById('empty').style.display='none';
    var _fc=new Date();
  document.getElementById('lastUpd').innerHTML=
    '<span style="color:var(--mu);font-size:9px;margin-right:4px">‚óè</span>Cache: '
    +_fc.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'})
    +' <span style="color:var(--acc);font-weight:600">'
    +_fc.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true})+'</span>';
  }
  // Auto-fetch if user/visitor has no cached data at all
  var needFetch=db.filter(function(t){return !rows[t.sym]||rows[t.sym].err;}).map(function(t){return t.sym;});
  if(needFetch.length){
    document.getElementById('tbl').style.display='';
    document.getElementById('empty').style.display='none';
    go(needFetch);
  }
  startARTimer(60);
  initScrollSync();
}

bootstrap();
</script>
</body>
</html>
